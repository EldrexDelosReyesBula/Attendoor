<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <title>NearCheck Lite - Smart Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js" as="script">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Favicon and PWA assets -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <!-- Motion libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>

    <style>
        /* Base styles with fluid typography */
        :root {
            --color-primary: 59, 130, 246;
            --color-success: 16, 185, 129;
            --color-warning: 245, 158, 11;
            --color-danger: 239, 68, 68;
            --color-dark: 17, 24, 39;
            --color-light: 249, 250, 251;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        @media (min-width: 640px) {
            html {
                font-size: calc(16px + 0.25vw);
            }
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            overscroll-behavior-y: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Custom components */
        .avatar {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgb(var(--color-primary)), #8b5cf6);
            color: white;
            font-weight: 600;
            user-select: none;
        }

        .check-in-btn {
            background: linear-gradient(135deg, rgb(var(--color-success)), rgb(var(--color-primary)));
            box-shadow: 0 4px 20px -6px rgba(var(--color-success), 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
        }

        .check-in-btn:hover {
            background: linear-gradient(135deg, #0ea472, #2563eb);
            transform: translateY(-2px);
            box-shadow: 0 6px 24px -6px rgba(var(--color-success), 0.5);
        }

        .check-in-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 12px -4px rgba(var(--color-success), 0.4);
        }

        .active-session {
            box-shadow: 0 0 0 2px rgb(var(--color-success)), 0 4px 20px -6px rgba(var(--color-success), 0.3);
        }

        /* Apple-style inputs */
        .input-field {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(209, 213, 219, 0.5);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .input-field:focus {
            border-color: rgb(var(--color-primary));
            box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.2);
        }

        .dark .input-field {
            border-color: rgba(55, 65, 81, 0.5);
            background-color: rgba(31, 41, 55, 0.5);
        }

        .dark .input-field:focus {
            border-color: rgb(var(--color-primary));
            box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.3);
        }

        /* Physics-based card hover */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform-origin: center bottom;
        }

        .card-hover:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .dark .card-hover:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Status indicators */
        .status-indicator {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            display: inline-block;
        }

        .status-indicator.active {
            background-color: rgb(var(--color-success));
            box-shadow: 0 0 0 2px rgba(var(--color-success), 0.3);
        }

        .status-indicator.inactive {
            background-color: rgb(156, 163, 175);
            box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.3);
        }

        /* Progress ring */
        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring__circle {
            stroke-dasharray: 100 100;
            transition: stroke-dashoffset 0.6s ease-out;
        }

        /* Micro-interactions */
        .click-feedback:active {
            transform: scale(0.98);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Skeleton loading */
        .skeleton {
            background-color: #e5e7eb;
            background-image: linear-gradient(90deg, #e5e7eb 0px, #f3f4f6 40px, #e5e7eb 80px);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 0.375rem;
        }

        .dark .skeleton {
            background-color: #374151;
            background-image: linear-gradient(90deg, #374151 0px, #4b5563 40px, #374151 80px);
        }

        @keyframes shimmer {
            0% {
                background-position: -100px 0;
            }

            100% {
                background-position: 100px 0;
            }
        }
    </style>
</head>

<body class="font-[Poppins] bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen">
    <!-- App Container -->
    <div id="appContainer" class="relative min-h-screen flex flex-col">
        <!-- Auth Overlay -->
        <div id="authOverlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 fade-in">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <div class="flex justify-center mb-6">
                    <div class="avatar h-16 w-16 rounded-2xl text-2xl float">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Welcome to NearCheck Lite</h2>

                <div id="loginForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="your@email.com" autocomplete="username">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="••••••••" autocomplete="current-password">
                    </div>
                    <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition-colors mb-4 flex items-center justify-center click-feedback">
                        <span id="loginBtnText">Sign In</span>
                        <svg id="loginSpinner" class="hidden h-5 w-5 ml-2 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p class="text-center text-gray-600 dark:text-gray-400 text-sm">
                        Don't have an account?
                        <button onclick="toggleAuthForm()" class="text-blue-600 dark:text-blue-400 font-medium hover:underline focus:outline-none">Register</button>
                    </p>
                </div>

                <div id="registerForm" class="hidden">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Full Name</label>
                        <input type="text" id="fullName" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="John Doe" autocomplete="name">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Email</label>
                        <input type="email" id="regEmail" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="your@email.com" autocomplete="email">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Password</label>
                        <input type="password" id="regPassword" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="••••••••" autocomplete="new-password">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum 8 characters</p>
                    </div>
                    <button onclick="register()" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition-colors mb-4 flex items-center justify-center click-feedback">
                        <span id="registerBtnText">Create Account</span>
                        <svg id="registerSpinner" class="hidden h-5 w-5 ml-2 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <p class="text-center text-gray-600 dark:text-gray-400 text-sm">
                        Already have an account?
                        <button onclick="toggleAuthForm()" class="text-blue-600 dark:text-blue-400 font-medium hover:underline focus:outline-none">Sign In</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="mainContent" class="hidden flex-grow">
            <!-- Navigation -->
            <nav class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40 backdrop-blur-sm bg-opacity-80 dark:bg-opacity-80">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16 items-center">
                        <div class="flex items-center">
                            <h1 class="text-xl font-semibold dark:text-white flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                                NearCheck Lite
                            </h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div id="userAvatar" class="avatar h-8 w-8 rounded-full text-sm cursor-pointer hover:opacity-90 transition-opacity click-feedback" onclick="showUserMenu()"></div>
                            <button id="themeToggle" class="p-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors click-feedback">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 dark:text-yellow-400 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- User Menu Dropdown -->
            <div id="userMenu" class="hidden absolute right-4 top-16 mt-2 w-56 bg-white dark:bg-gray-800 rounded-xl shadow-lg z-50 overflow-hidden slide-up border border-gray-200 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-sm font-medium dark:text-white" id="userMenuName">User Name</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 truncate" id="userMenuEmail">user@example.com</p>
                </div>
                <div class="py-1">
                    <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
                <!-- Active Section View -->
                <div id="activeSectionView" class="mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold dark:text-white">Active Section</h2>
                        <button id="newSectionBtn" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors flex items-center click-feedback">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Add
                        </button>
                    </div>

                    <div id="activeSectionContainer" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden transition-all duration-300">
                        <!-- Content will be dynamically loaded here -->
                        <div id="noActiveSection" class="p-8 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-lg font-medium text-gray-600 dark:text-gray-300 mt-4">No active section</h3>
                            <p class="text-gray-500 dark:text-gray-400 mt-2">Select a section from your list or create a new one</p>
                            <button id="selectSectionBtn" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition-colors click-feedback">
                                Select Section
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Session Controls -->
                <div id="sessionControls" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8 transition-all duration-300">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="mb-4 md:mb-0">
                            <h3 class="text-lg font-semibold dark:text-white flex items-center">
                                <span id="sessionStatusIndicator" class="status-indicator inactive mr-2"></span>
                                <span id="sessionStatusText">Session Inactive</span>
                            </h3>
                            <p id="sessionInfo" class="text-gray-600 dark:text-gray-400">No active session</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="toggleGPSBtn" class="border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-xl dark:text-white flex items-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span id="gpsStatusText">GPS Off</span>
                            </button>
                            <button id="toggleSessionBtn" class="bg-gray-600 text-white px-6 py-2 rounded-xl hover:bg-gray-700 transition-colors click-feedback">
                                Start Session
                            </button>
                        </div>
                    </div>

                    <!-- Check-in Stats -->
                    <div id="checkInStats" class="mt-6 hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-xl">
                                <h4 class="text-gray-500 dark:text-gray-400 text-sm">Total Students</h4>
                                <p id="totalStudents" class="text-xl font-bold dark:text-white">0</p>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-xl">
                                <h4 class="text-gray-500 dark:text-gray-400 text-sm">Checked In</h4>
                                <p id="checkedInStudents" class="text-xl font-bold dark:text-white">0</p>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-xl">
                                <h4 class="text-gray-500 dark:text-gray-400 text-sm">Pending</h4>
                                <p id="pendingStudents" class="text-xl font-bold dark:text-white">0</p>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-xl flex items-center">
                                <div class="mr-3 relative">
                                    <svg class="w-12 h-12" viewBox="0 0 36 36">
                                        <circle cx="18" cy="18" r="16" fill="none" class="stroke-gray-200 dark:stroke-gray-600" stroke-width="3"></circle>
                                        <path class="progress-ring__circle stroke-green-500" stroke-width="3" stroke-dasharray="100 100" stroke-linecap="round" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                                    </svg>
                                    <span id="checkInPercentage" class="absolute inset-0 flex items-center justify-center text-xs font-bold dark:text-white">0%</span>
                                </div>
                                <div>
                                    <h4 class="text-gray-500 dark:text-gray-400 text-sm">Completion</h4>
                                    <p id="checkInPercentageText" class="text-sm font-medium dark:text-white">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Check-in List -->
                <div id="checkInListContainer" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden mb-8 transition-all duration-300">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h3 class="text-lg font-semibold dark:text-white">Student Check-ins</h3>
                        <div class="flex items-center space-x-2">
                            <button id="exportBtn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors click-feedback" title="Export Data">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </button>
                            <button id="refreshBtn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors click-feedback" title="Refresh">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="checkInList" class="divide-y divide-gray-200 dark:divide-gray-700 max-h-[500px] overflow-y-auto">
                        <!-- Students will be listed here -->
                    </div>
                </div>

                <!-- All Sections -->
                <div id="allSectionsView" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="hideAllSections()" class="text-blue-600 dark:text-blue-400 hover:underline focus:outline-none">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 class="text-2xl font-bold dark:text-white">Your Sections</h2>
                    </div>

                    <div id="sectionsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Sections will be loaded here -->
                    </div>
                </div>
            </main>

            <!-- Toast Notification -->
            <div id="toast" class="hidden fixed bottom-4 right-4 z-50">
                <div class="bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg flex items-start max-w-xs">
                    <div id="toastIcon" class="mr-3 mt-0.5"></div>
                    <div>
                        <h4 id="toastTitle" class="font-medium"></h4>
                        <p id="toastMessage" class="text-sm text-gray-300"></p>
                    </div>
                    <button onclick="hideToast()" class="ml-4 text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 fade-in backdrop-blur-sm">
            <!-- New Section Modal -->
            <div id="newSectionModal" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Create New Section</h3>
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Section Name</label>
                    <input type="text" id="sectionName" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="e.g. CS101-A">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Subject Code</label>
                    <input type="text" id="subjectCode" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="e.g. CS101">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2 text-sm font-medium">Schedule</label>
                    <input type="text" id="sectionSchedule" class="w-full px-4 py-3 input-field rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none" placeholder="e.g. Mon/Wed 10:00-11:30">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                        Cancel
                    </button>
                    <button onclick="createSection()" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors click-feedback">
                        Create
                    </button>
                </div>
            </div>

            <!-- Section Actions Modal -->
            <div id="sectionActionsModal" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <h3 id="sectionActionsTitle" class="text-xl font-bold mb-4 dark:text-white">Section Actions</h3>
                <div class="space-y-3">
                    <button onclick="activateSection()" class="w-full text-left px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl transition-colors flex items-center click-feedback">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <div>
                            <h4 class="font-medium dark:text-white">Set as Active</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Make this your current section</p>
                        </div>
                    </button>
                    <button onclick="showInviteStudents()" class="w-full text-left px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl transition-colors flex items-center click-feedback">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                        <div>
                            <h4 class="font-medium dark:text-white">Invite Students</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Generate invite link for students</p>
                        </div>
                    </button>
                    <button onclick="confirmDeleteSection()" class="w-full text-left px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl transition-colors flex items-center click-feedback">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <div>
                            <h4 class="font-medium dark:text-white">Delete Section</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Permanently remove this section</p>
                        </div>
                    </button>
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                        Close
                    </button>
                </div>
            </div>

            <!-- Invite Students Modal -->
            <div id="inviteStudentsModal" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Invite Students</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Share this link with your students to join this section:</p>
                <div class="flex mb-6">
                    <input id="inviteLink" type="text" readonly class="flex-grow px-4 py-3 input-field rounded-l-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-none truncate">
                    <button onclick="copyInviteLink()" class="bg-blue-600 text-white px-4 py-3 rounded-r-xl hover:bg-blue-700 transition-colors click-feedback">
                        Copy
                    </button>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900 dark:bg-opacity-20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4 mb-6">
                    <h4 class="font-medium text-yellow-800 dark:text-yellow-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Important
                    </h4>
                    <p class="text-yellow-700 dark:text-yellow-300 text-sm mt-2">
                        Students will need to register with their institutional email to join this section.
                    </p>
                </div>
                <div class="flex justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                        Done
                    </button>
                </div>
            </div>

            <!-- Confirm Delete Modal -->
            <div id="confirmDeleteModal" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Confirm Deletion</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to delete this section? All attendance data will be permanently removed.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                        Cancel
                    </button>
                    <button onclick="deleteSection()" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition-colors click-feedback">
                        Delete Section
                    </button>
                </div>
            </div>

            <!-- GPS Permission Modal -->
            <div id="gpsModal" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Location Access Required</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">NearCheck Lite needs access to your location to verify student check-ins. Your location data is only used during active sessions and is not stored permanently.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="denyGPS()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                        Deny
                    </button>
                    <button onclick="allowGPS()" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors click-feedback">
                        Allow
                    </button>
                </div>
            </div>

            <!-- Privacy Modal -->
            <div id="privacyModal" class="hidden bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4 slide-up" style="transform-origin: center center;">
                <h3 class="text-xl font-bold mb-4 dark:text-white">Privacy & Permissions</h3>
                <div class="space-y-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium dark:text-white">Location Data</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Used only during active sessions to verify student proximity. Never stored permanently.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium dark:text-white">Student Data</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Stored securely and only accessible to you. Never shared with third parties.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium dark:text-white">Analytics</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Anonymous usage data helps us improve the app. No personal information is collected.</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors click-feedback">
                        I Understand
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>

    <!-- App JavaScript -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVP8zaUj2iDrooLbRQNypHqB8QNTLhGDE",
            authDomain: "attendance-fe1c8.firebaseapp.com",
            projectId: "attendance-fe1c8",
            storageBucket: "attendance-fe1c8.firebasestorage.app",
            messagingSenderId: "903463376704",
            appId: "1:903463376704:web:d004c563d56aa286df8ca5",
            measurementId: "G-YY5GQZPSRK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Global Variables
        let currentUser = null;
        let activeSection = null;
        let sections = [];
        let students = [];
        let checkIns = [];
        let isSessionActive = false;
        let isGPSEnabled = false;
        let currentLocation = null;
        let unsubscribeSections = null;
        let unsubscribeStudents = null;
        let unsubscribeCheckIns = null;
        let selectedSectionForAction = null;
        let toastTimeout = null;

        // DOM Elements
        const authOverlay = document.getElementById('authOverlay');
        const mainContent = document.getElementById('mainContent');
        const userAvatar = document.getElementById('userAvatar');
        const userMenu = document.getElementById('userMenu');
        const userMenuName = document.getElementById('userMenuName');
        const userMenuEmail = document.getElementById('userMenuEmail');
        const themeToggle = document.getElementById('themeToggle');
        const activeSectionContainer = document.getElementById('activeSectionContainer');
        const noActiveSection = document.getElementById('noActiveSection');
        const selectSectionBtn = document.getElementById('selectSectionBtn');
        const newSectionBtn = document.getElementById('newSectionBtn');
        const sessionControls = document.getElementById('sessionControls');
        const toggleSessionBtn = document.getElementById('toggleSessionBtn');
        const toggleGPSBtn = document.getElementById('toggleGPSBtn');
        const gpsStatusText = document.getElementById('gpsStatusText');
        const sessionStatusText = document.getElementById('sessionStatusText');
        const sessionStatusIndicator = document.getElementById('sessionStatusIndicator');
        const sessionInfo = document.getElementById('sessionInfo');
        const checkInStats = document.getElementById('checkInStats');
        const totalStudents = document.getElementById('totalStudents');
        const checkedInStudents = document.getElementById('checkedInStudents');
        const pendingStudents = document.getElementById('pendingStudents');
        const checkInPercentage = document.getElementById('checkInPercentage');
        const checkInPercentageText = document.getElementById('checkInPercentageText');
        const checkInListContainer = document.getElementById('checkInListContainer');
        const checkInList = document.getElementById('checkInList');
        const exportBtn = document.getElementById('exportBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const allSectionsView = document.getElementById('allSectionsView');
        const sectionsGrid = document.getElementById('sectionsGrid');
        const modalOverlay = document.getElementById('modalOverlay');
        const newSectionModal = document.getElementById('newSectionModal');
        const sectionActionsModal = document.getElementById('sectionActionsModal');
        const sectionActionsTitle = document.getElementById('sectionActionsTitle');
        const inviteStudentsModal = document.getElementById('inviteStudentsModal');
        const inviteLink = document.getElementById('inviteLink');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const gpsModal = document.getElementById('gpsModal');
        const privacyModal = document.getElementById('privacyModal');
        const sectionNameInput = document.getElementById('sectionName');
        const subjectCodeInput = document.getElementById('subjectCode');
        const sectionScheduleInput = document.getElementById('sectionSchedule');
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginSpinner = document.getElementById('loginSpinner');
        const registerBtnText = document.getElementById('registerBtnText');
        const registerSpinner = document.getElementById('registerSpinner');

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            checkForUpdates();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);

            // Section navigation
            selectSectionBtn.addEventListener('click', showAllSections);
            newSectionBtn.addEventListener('click', showNewSectionModal);

            // Session controls
            toggleSessionBtn.addEventListener('click', toggleSession);
            toggleGPSBtn.addEventListener('click', toggleGPS);

            // Check-in list actions
            exportBtn.addEventListener('click', exportCheckInData);
            refreshBtn.addEventListener('click', refreshCheckInData);

            // Close modals when clicking outside
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });

            // Close user menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!userMenu.contains(e.target) && e.target !== userAvatar) {
                    userMenu.classList.add('hidden');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!modalOverlay.classList.contains('hidden')) {
                        closeModal();
                    }
                    if (!userMenu.classList.contains('hidden')) {
                        userMenu.classList.add('hidden');
                    }
                }
            });
        }

        // Check for app updates
        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update().then(() => {
                        console.log('Checked for updates');
                    });
                });
            }
        }

        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    setupUser();
                    loadSections();
                    showApp();

                    // Check for pending actions after login
                    checkPendingActions();
                } else {
                    showAuth();
                }
            });
        }

        // Check for pending actions (like invite codes)
        function checkPendingActions() {
            const params = new URLSearchParams(window.location.search);
            const inviteCode = params.get('invite');

            if (inviteCode) {
                try {
                    const decoded = atob(inviteCode);
                    const [teacherId, sectionId] = decoded.split(':');

                    // In a full implementation, you would handle student registration
                    console.log("Invite detected for section:", sectionId, "from teacher:", teacherId);

                    // Clean the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error("Invalid invite code");
                }
            }
        }

        // Setup user profile
        function setupUser() {
            const displayName = currentUser.displayName || 'User';
            const email = currentUser.email || '';
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();

            userAvatar.textContent = initials;
            userAvatar.style.backgroundColor = stringToColor(displayName);

            userMenuName.textContent = displayName;
            userMenuEmail.textContent = email;
        }

        // Show user menu
        function showUserMenu() {
            userMenu.classList.toggle('hidden');

            if (!userMenu.classList.contains('hidden')) {
                // Animate menu appearance
                gsap.from(userMenu, {
                    duration: 0.2,
                    opacity: 0,
                    y: -10,
                    ease: "power2.out"
                });
            }
        }

        // Login function
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showToast('Missing Information', 'Please enter both email and password', 'warning');
                return;
            }

            // Show loading state
            loginBtnText.textContent = 'Signing In...';
            loginSpinner.classList.remove('hidden');

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // Success handled by auth state listener
                })
                .catch(error => {
                    loginBtnText.textContent = 'Sign In';
                    loginSpinner.classList.add('hidden');

                    let errorMessage = 'Login failed. Please try again.';
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'No account found with this email.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Incorrect password. Please try again.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many attempts. Please try again later.';
                            break;
                    }

                    showToast('Login Failed', errorMessage, 'error');
                });
        }

        // Register function
        function register() {
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!fullName || !email || !password) {
                showToast('Missing Information', 'Please fill in all fields', 'warning');
                return;
            }

            if (password.length < 8) {
                showToast('Weak Password', 'Password must be at least 8 characters', 'warning');
                return;
            }

            // Show loading state
            registerBtnText.textContent = 'Creating Account...';
            registerSpinner.classList.remove('hidden');

            auth.createUserWithEmailAndPassword(email, password)
                .then(cred => {
                    return cred.user.updateProfile({
                        displayName: fullName
                    });
                })
                .then(() => {
                    // Success handled by auth state listener
                })
                .catch(error => {
                    registerBtnText.textContent = 'Create Account';
                    registerSpinner.classList.add('hidden');

                    let errorMessage = 'Registration failed. Please try again.';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'Email already in use. Please sign in.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Please enter a valid email address.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password should be at least 8 characters.';
                            break;
                    }

                    showToast('Registration Failed', errorMessage, 'error');
                });
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                resetAppState();
                showAuth();
                showToast('Signed Out', 'You have been successfully signed out', 'success');
            });
        }

        // Toggle auth forms
        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            // Animate transition between forms
            gsap.to(loginForm.classList.contains('hidden') ? registerForm : loginForm, {
                duration: 0.2,
                opacity: 0,
                y: 10,
                ease: "power2.in",
                onComplete: () => {
                    loginForm.classList.toggle('hidden');
                    registerForm.classList.toggle('hidden');

                    gsap.from(loginForm.classList.contains('hidden') ? registerForm : loginForm, {
                        duration: 0.3,
                        opacity: 0,
                        y: -10,
                        ease: "power2.out"
                    });
                }
            });
        }

        // Load user's sections
        function loadSections() {
            if (unsubscribeSections) unsubscribeSections();

            // Show skeleton loading
            sectionsGrid.innerHTML = `
                <div class="col-span-full space-y-4">
                    ${Array(3).fill().map(() => `
                        <div class="skeleton h-32 rounded-xl"></div>
                    `).join('')}
                </div>
            `;

            unsubscribeSections = db.collection('sections')
                .where('teacherId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    sections = [];
                    snapshot.forEach(doc => {
                        sections.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    renderSections();

                    // Check if active section still exists
                    if (activeSection && !sections.some(s => s.id === activeSection.id)) {
                        activeSection = null;
                        renderActiveSection();
                    }

                    // Check for stored active section if none is set
                    if (!activeSection) {
                        const storedSectionId = localStorage.getItem(`activeSection_${currentUser.uid}`);
                        if (storedSectionId) {
                            const section = sections.find(s => s.id === storedSectionId);
                            if (section) setActiveSection(section);
                        }
                    }
                }, error => {
                    console.error("Error loading sections:", error);
                    showToast('Error', 'Failed to load sections', 'error');
                });
        }

        // Render sections
        function renderSections() {
            if (allSectionsView.classList.contains('hidden')) return;

            sectionsGrid.innerHTML = '';

            if (sections.length === 0) {
                sectionsGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-600 dark:text-gray-300 mt-4">No sections yet</h3>
                        <p class="text-gray-500 dark:text-gray-400 mt-2">Create your first section to get started</p>
                    </div>
                `;
                return;
            }

            // Animate sections appearance
            gsap.from(sections.map((_, i) => {
                const sectionEl = document.createElement('div');
                const isActive = activeSection && sections[i].id === activeSection.id;

                sectionEl.className = `bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden transition-all duration-300 card-hover ${isActive ? 'active-session' : ''}`;
                sectionEl.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold dark:text-white truncate">${sections[i].name}</h3>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${sections[i].subjectCode || ''}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">${sections[i].schedule || 'No schedule set'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                ${sections[i].studentCount || 0} students
                            </span>
                            <button data-section-id="${sections[i].id}" class="text-blue-600 dark:text-blue-400 hover:underline focus:outline-none">
                                Manage
                            </button>
                        </div>
                    </div>
                `;

                sectionEl.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showSectionActionsModal(sections[i]);
                });

                sectionEl.addEventListener('click', () => {
                    setActiveSection(sections[i]);
                    hideAllSections();
                });

                sectionsGrid.appendChild(sectionEl);
                return sectionEl;
            }), {
                duration: 0.3,
                opacity: 0,
                y: 20,
                stagger: 0.05,
                ease: "power2.out"
            });
        }

        // Set active section
        function setActiveSection(section) {
            activeSection = section;
            localStorage.setItem(`activeSection_${currentUser.uid}`, section.id);
            renderActiveSection();
            loadStudents();

            // Animate the active section change
            gsap.from(activeSectionContainer, {
                duration: 0.3,
                opacity: 0,
                y: 10,
                ease: "power2.out"
            });
        }

        // Render active section
        function renderActiveSection() {
            if (!activeSection) {
                activeSectionContainer.innerHTML = noActiveSection.innerHTML;
                sessionControls.classList.add('hidden');
                checkInListContainer.classList.add('hidden');
                return;
            }

            activeSectionContainer.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xl font-bold dark:text-white">${activeSection.name}</h2>
                            <p class="text-gray-600 dark:text-gray-400">${activeSection.subjectCode || ''} • ${activeSection.schedule || ''}</p>
                        </div>
                        <button onclick="showSectionActionsModal(activeSection)" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 click-feedback">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl">
                            <h4 class="text-gray-500 dark:text-gray-400 text-xs">Total Students</h4>
                            <p class="text-lg font-bold dark:text-white">${activeSection.studentCount || 0}</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-xl">
                            <h4 class="text-gray-500 dark:text-gray-400 text-xs">Last Session</h4>
                            <p class="text-lg font-bold dark:text-white">${activeSection.lastSessionDate || 'Never'}</p>
                        </div>
                    </div>
                    <button id="startSessionBtn" class="w-full check-in-btn text-white py-3 rounded-xl transition-colors font-medium click-feedback">
                        Start Attendance Session
                    </button>
                </div>
            `;

            document.getElementById('startSessionBtn').addEventListener('click', toggleSession);
            sessionControls.classList.remove('hidden');
            updateSessionUI();
        }

        // Load students for active section
        function loadStudents() {
            if (!activeSection || unsubscribeStudents) unsubscribeStudents();

            // Show loading state in check-in list
            checkInList.innerHTML = `
                <div class="space-y-4 p-4">
                    ${Array(5).fill().map(() => `
                        <div class="flex items-center space-x-4 p-3">
                            <div class="skeleton h-10 w-10 rounded-full"></div>
                            <div class="flex-1 space-y-2">
                                <div class="skeleton h-4 w-3/4 rounded"></div>
                                <div class="skeleton h-3 w-1/2 rounded"></div>
                            </div>
                            <div class="skeleton h-6 w-16 rounded-full"></div>
                        </div>
                    `).join('')}
                </div>
            `;

            unsubscribeStudents = db.collection('students')
                .where('sectionId', '==', activeSection.id)
                .onSnapshot(snapshot => {
                    students = [];
                    snapshot.forEach(doc => {
                        students.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    if (isSessionActive) {
                        loadCheckIns();
                    }

                    updateStats();
                }, error => {
                    console.error("Error loading students:", error);
                    showToast('Error', 'Failed to load students', 'error');
                });
        }

        // Load check-ins for current session
        function loadCheckIns() {
            if (!activeSection || !isSessionActive || unsubscribeCheckIns) unsubscribeCheckIns();

            const sessionId = getCurrentSessionId();
            unsubscribeCheckIns = db.collection('checkIns')
                .where('sessionId', '==', sessionId)
                .onSnapshot(snapshot => {
                    checkIns = [];
                    snapshot.forEach(doc => {
                        checkIns.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    renderCheckInList();
                    updateStats();
                }, error => {
                    console.error("Error loading check-ins:", error);
                    showToast('Error', 'Failed to load check-ins', 'error');
                });
        }

        // Render check-in list
        function renderCheckInList() {
            checkInList.innerHTML = '';

            if (students.length === 0) {
                checkInList.innerHTML = `
                    <div class="p-6 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-600 dark:text-gray-300 mt-4">No students in this section</h3>
                        <p class="text-gray-500 dark:text-gray-400 mt-2">Invite students to join this section</p>
                    </div>
                `;
                return;
            }

            // Animate student entries
            gsap.from(students.map((student, i) => {
                const checkIn = checkIns.find(c => c.studentId === student.id);
                const row = document.createElement('div');
                row.className = 'p-4 flex items-center';

                const statusClass = checkIn ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
                const statusText = checkIn ? 'Checked In' : 'Pending';
                const timeText = checkIn ? formatTime(checkIn.timestamp) : '';

                row.innerHTML = `
                    <div class="avatar h-10 w-10 rounded-full text-sm mr-4"></div>
                    <div class="flex-grow">
                        <h4 class="font-medium dark:text-white">${student.fullName}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${student.email}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                        ${timeText ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${timeText}</p>` : ''}
                    </div>
                `;

                // Set avatar
                const avatar = row.querySelector('.avatar');
                const initials = student.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                avatar.textContent = initials;
                avatar.style.backgroundColor = stringToColor(student.fullName);

                checkInList.appendChild(row);
                return row;
            }), {
                duration: 0.2,
                opacity: 0,
                x: -10,
                stagger: 0.03,
                ease: "power1.out"
            });

            checkInListContainer.classList.remove('hidden');
        }

        // Update stats
        function updateStats() {
            if (!activeSection) return;

            const total = students.length;
            const checkedIn = checkIns.length;
            const pending = total - checkedIn;
            const percentage = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

            totalStudents.textContent = total;
            checkedInStudents.textContent = checkedIn;
            pendingStudents.textContent = pending;
            checkInPercentage.textContent = `${percentage}%`;
            checkInPercentageText.textContent = `${percentage}%`;

            // Update progress ring
            const progressRing = document.querySelector('.progress-ring__circle');
            if (progressRing) {
                const circumference = 2 * Math.PI * 16;
                const offset = circumference - (percentage / 100) * circumference;
                progressRing.style.strokeDashoffset = offset;
            }

            if (isSessionActive) {
                checkInStats.classList.remove('hidden');
            }
        }

        // Toggle session
        function toggleSession() {
            if (!activeSection) {
                showToast('No Active Section', 'Please select a section first', 'warning');
                return;
            }

            if (isSessionActive) {
                endSession();
            } else {
                startSession();
            }
        }

        // Start session
        function startSession() {
            const sessionId = getCurrentSessionId();
            const sessionData = {
                sectionId: activeSection.id,
                teacherId: currentUser.uid,
                startTime: firebase.firestore.FieldValue.serverTimestamp(),
                gpsEnabled: isGPSEnabled,
                status: 'active'
            };

            // Show loading state
            toggleSessionBtn.innerHTML = '<span class="pulse">Starting...</span>';

            // Use Firestore for session data
            db.collection('sessions').doc(sessionId).set(sessionData)
                .then(() => {
                    // Use Realtime DB for active session status
                    return rtdb.ref(`activeSessions/${activeSection.id}`).set({
                        active: true,
                        gpsEnabled: isGPSEnabled,
                        teacherId: currentUser.uid,
                        startTime: Date.now()
                    });
                })
                .then(() => {
                    isSessionActive = true;
                    updateSessionUI();
                    loadCheckIns();
                    showToast('Session Started', 'Students can now check in', 'success');

                    // Request notification permission
                    if (Notification.permission !== 'granted') {
                        Notification.requestPermission();
                    }
                })
                .catch(error => {
                    console.error("Error starting session:", error);
                    showToast('Session Error', 'Failed to start session', 'error');
                    updateSessionUI();
                });
        }

        // End session
        function endSession() {
            const sessionId = getCurrentSessionId();

            // Show loading state
            toggleSessionBtn.innerHTML = '<span class="pulse">Ending...</span>';

            // Update Firestore session
            db.collection('sessions').doc(sessionId).update({
                    endTime: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                })
                .then(() => {
                    // Update Realtime DB
                    return rtdb.ref(`activeSessions/${activeSection.id}`).remove();
                })
                .then(() => {
                    // Update section last session date
                    return db.collection('sections').doc(activeSection.id).update({
                        lastSessionDate: new Date().toLocaleDateString()
                    });
                })
                .then(() => {
                    isSessionActive = false;
                    updateSessionUI();
                    showToast('Session Ended', 'Check-in is now closed', 'success');
                })
                .catch(error => {
                    console.error("Error ending session:", error);
                    showToast('Session Error', 'Failed to end session', 'error');
                    updateSessionUI();
                });
        }

        // Update session UI
        function updateSessionUI() {
            if (isSessionActive) {
                sessionStatusText.textContent = 'Session Active';
                sessionStatusIndicator.className = 'status-indicator active mr-2';
                sessionInfo.textContent = 'Students can check in now';
                toggleSessionBtn.textContent = 'End Session';
                toggleSessionBtn.className = 'bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 transition-colors click-feedback';

                if (document.getElementById('startSessionBtn')) {
                    document.getElementById('startSessionBtn').textContent = 'End Attendance Session';
                    document.getElementById('startSessionBtn').className = 'w-full bg-red-600 text-white py-3 rounded-xl transition-colors font-medium hover:bg-red-700 click-feedback';
                }
            } else {
                sessionStatusText.textContent = 'Session Inactive';
                sessionStatusIndicator.className = 'status-indicator inactive mr-2';
                sessionInfo.textContent = 'No active session';
                toggleSessionBtn.textContent = 'Start Session';
                toggleSessionBtn.className = 'bg-green-600 text-white px-6 py-2 rounded-xl hover:bg-green-700 transition-colors click-feedback';

                if (document.getElementById('startSessionBtn')) {
                    document.getElementById('startSessionBtn').textContent = 'Start Attendance Session';
                    document.getElementById('startSessionBtn').className = 'w-full check-in-btn text-white py-3 rounded-xl transition-colors font-medium click-feedback';
                }
            }

            gpsStatusText.textContent = isGPSEnabled ? 'GPS On' : 'GPS Off';
            checkInStats.classList.toggle('hidden', !isSessionActive);
        }

        // Toggle GPS
        function toggleGPS() {
            if (isGPSEnabled) {
                isGPSEnabled = false;
                updateSessionUI();

                if (isSessionActive) {
                    // Update session with GPS status
                    const sessionId = getCurrentSessionId();
                    db.collection('sessions').doc(sessionId).update({
                        gpsEnabled: false
                    });

                    rtdb.ref(`activeSessions/${activeSection.id}/gpsEnabled`).set(false);
                }
            } else {
                showGPSModal();
            }
        }

        // Show GPS modal
        function showGPSModal() {
            gpsModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');

            // Animate modal appearance
            gsap.from(gpsModal, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });
        }

        // Allow GPS
        function allowGPS() {
            if (!navigator.geolocation) {
                showToast('Geolocation Not Supported', 'Your browser doesn\'t support geolocation', 'error');
                closeModal();
                return;
            }

            // Show loading state
            const allowBtn = gpsModal.querySelector('button.bg-blue-600');
            allowBtn.innerHTML = '<span class="pulse">Detecting...</span>';

            navigator.geolocation.getCurrentPosition(
                position => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    isGPSEnabled = true;

                    if (isSessionActive) {
                        // Update session with GPS status
                        const sessionId = getCurrentSessionId();
                        db.collection('sessions').doc(sessionId).update({
                            gpsEnabled: true,
                            location: new firebase.firestore.GeoPoint(currentLocation.lat, currentLocation.lng)
                        });

                        rtdb.ref(`activeSessions/${activeSection.id}/gpsEnabled`).set(true);
                    }

                    updateSessionUI();
                    closeModal();
                    showToast('Location Enabled', 'GPS verification is now active', 'success');
                },
                error => {
                    showToast('Location Access Denied', 'You need to allow location access to use GPS verification', 'error');
                    closeModal();
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Deny GPS
        function denyGPS() {
            isGPSEnabled = false;
            closeModal();
        }

        // Create new section
        function createSection() {
            const name = sectionNameInput.value.trim();
            const subjectCode = subjectCodeInput.value.trim();
            const schedule = sectionScheduleInput.value.trim();

            if (!name) {
                showToast('Missing Information', 'Section name is required', 'warning');
                return;
            }

            const sectionData = {
                name,
                subjectCode,
                schedule,
                teacherId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                studentCount: 0
            };

            // Show loading state
            const createBtn = newSectionModal.querySelector('button.bg-blue-600');
            createBtn.innerHTML = '<span class="pulse">Creating...</span>';

            db.collection('sections').add(sectionData)
                .then(docRef => {
                    showToast('Section Created', `${name} has been created successfully`, 'success');
                    setActiveSection({
                        id: docRef.id,
                        ...sectionData
                    });
                    closeModal();
                    resetSectionForm();
                })
                .catch(error => {
                    console.error("Error creating section:", error);
                    showToast('Error', 'Failed to create section', 'error');
                })
                .finally(() => {
                    createBtn.textContent = 'Create';
                });
        }

        // Show section actions modal
        function showSectionActionsModal(section) {
            selectedSectionForAction = section;
            sectionActionsTitle.textContent = section.name;
            sectionActionsModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');

            // Animate modal appearance
            gsap.from(sectionActionsModal, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });
        }

        // Show invite students modal
        function showInviteStudents() {
            if (!selectedSectionForAction) return;

            const inviteCode = btoa(`${currentUser.uid}:${selectedSectionForAction.id}`).replace(/=/g, '');
            const inviteUrl = `${window.location.origin}${window.location.pathname}?invite=${inviteCode}`;

            inviteLink.value = inviteUrl;
            inviteStudentsModal.classList.remove('hidden');
            sectionActionsModal.classList.add('hidden');

            // Animate modal transition
            gsap.from(inviteStudentsModal, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });
        }

        // Copy invite link
        function copyInviteLink() {
            inviteLink.select();
            document.execCommand('copy');

            // Visual feedback
            const copyBtn = inviteStudentsModal.querySelector('button.bg-blue-600');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy';
            }, 2000);

            showToast('Copied!', 'Invite link has been copied to clipboard', 'success');
        }

        // Confirm delete section
        function confirmDeleteSection() {
            confirmDeleteModal.classList.remove('hidden');
            sectionActionsModal.classList.add('hidden');

            // Animate modal transition
            gsap.from(confirmDeleteModal, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });
        }

        // Delete section
        function deleteSection() {
            if (!selectedSectionForAction) return;

            // Show loading state
            const deleteBtn = confirmDeleteModal.querySelector('button.bg-red-600');
            deleteBtn.innerHTML = '<span class="pulse">Deleting...</span>';

            db.collection('sections').doc(selectedSectionForAction.id).delete()
                .then(() => {
                    showToast('Section Deleted', `${selectedSectionForAction.name} has been removed`, 'success');

                    if (activeSection && activeSection.id === selectedSectionForAction.id) {
                        activeSection = null;
                        localStorage.removeItem(`activeSection_${currentUser.uid}`);
                        renderActiveSection();
                    }

                    closeModal();
                    selectedSectionForAction = null;
                })
                .catch(error => {
                    console.error("Error deleting section:", error);
                    showToast('Error', 'Failed to delete section', 'error');
                })
                .finally(() => {
                    deleteBtn.textContent = 'Delete Section';
                });
        }

        // Activate section
        function activateSection() {
            if (!selectedSectionForAction) return;

            setActiveSection(selectedSectionForAction);
            closeModal();
        }

        // Show all sections
        function showAllSections() {
            allSectionsView.classList.remove('hidden');
            document.getElementById('activeSectionView').classList.add('hidden');

            // Animate transition
            gsap.from(allSectionsView, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "power2.out"
            });
        }

        // Hide all sections view
        function hideAllSections() {
            // Animate transition
            gsap.to(allSectionsView, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "power2.in",
                onComplete: () => {
                    allSectionsView.classList.add('hidden');
                    document.getElementById('activeSectionView').classList.remove('hidden');
                }
            });
        }

        // Show new section modal
        function showNewSectionModal() {
            newSectionModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');

            // Animate modal appearance
            gsap.from(newSectionModal, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });

            // Focus first input
            setTimeout(() => {
                sectionNameInput.focus();
            }, 100);
        }

        // Show privacy modal
        function showPrivacyModal() {
            privacyModal.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');

            // Animate modal appearance
            gsap.from(privacyModal, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });
        }

        // Close modal
        function closeModal() {
            // Animate modal disappearance
            const visibleModal = document.querySelector('#modalOverlay > div:not(.hidden)');
            if (visibleModal) {
                gsap.to(visibleModal, {
                    duration: 0.2,
                    opacity: 0,
                    y: 10,
                    ease: "power2.in",
                    onComplete: () => {
                        modalOverlay.classList.add('hidden');
                        document.querySelectorAll('#modalOverlay > div').forEach(modal => {
                            modal.classList.add('hidden');
                        });
                    }
                });
            } else {
                modalOverlay.classList.add('hidden');
                document.querySelectorAll('#modalOverlay > div').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }

            selectedSectionForAction = null;
        }

        // Reset section form
        function resetSectionForm() {
            sectionNameInput.value = '';
            subjectCodeInput.value = '';
            sectionScheduleInput.value = '';
        }

        // Export check-in data
        function exportCheckInData() {
            if (!activeSection || !isSessionActive || checkIns.length === 0) {
                showToast('No Data', 'No check-in data to export', 'warning');
                return;
            }

            const sessionId = getCurrentSessionId();
            const date = new Date().toISOString().split('T')[0];
            const filename = `NearCheck_${activeSection.name.replace(/\s+/g, '_')}_${date}.csv`;

            // Prepare CSV content
            let csvContent = "Student Name,Email,Check-in Time,Status\n";

            students.forEach(student => {
                const checkIn = checkIns.find(c => c.studentId === student.id);
                const status = checkIn ? 'Present' : 'Absent';
                const time = checkIn ? formatTime(checkIn.timestamp) : 'N/A';

                csvContent += `"${student.fullName}","${student.email}","${time}","${status}"\n`;
            });

            // Create download link
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Exported', 'Check-in data downloaded', 'success');
        }

        // Refresh check-in data
        function refreshCheckInData() {
            if (!activeSection) return;

            // Show loading state
            refreshBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>';

            if (isSessionActive) {
                loadCheckIns();
            } else {
                loadStudents();
            }

            setTimeout(() => {
                refreshBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>';
                showToast('Refreshed', 'Data has been updated', 'success');
            }, 1000);
        }

        // Show auth overlay
        function showAuth() {
            authOverlay.classList.remove('hidden');
            mainContent.classList.add('hidden');

            // Reset auth forms
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('fullName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';

            // Focus email input
            setTimeout(() => {
                document.getElementById('email').focus();
            }, 100);
        }

        // Show app
        function showApp() {
            authOverlay.classList.add('hidden');
            mainContent.classList.remove('hidden');

            // Show privacy notice on first visit
            const privacyAccepted = localStorage.getItem('privacyAccepted');
            if (!privacyAccepted) {
                setTimeout(() => {
                    showPrivacyModal();
                    localStorage.setItem('privacyAccepted', 'true');
                }, 1000);
            }
        }

        // Reset app state
        function resetAppState() {
            if (unsubscribeSections) unsubscribeSections();
            if (unsubscribeStudents) unsubscribeStudents();
            if (unsubscribeCheckIns) unsubscribeCheckIns();

            activeSection = null;
            sections = [];
            students = [];
            checkIns = [];
            isSessionActive = false;
            isGPSEnabled = false;
            currentLocation = null;
            selectedSectionForAction = null;
        }

        // Toggle theme
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // Animate theme transition
            gsap.fromTo(document.documentElement, {
                backgroundColor: isDark ? '#f9fafb' : '#111827'
            }, {
                backgroundColor: isDark ? '#111827' : '#f9fafb',
                duration: 0.5
            });
        }

        // Show toast notification
        function showToast(title, message, type) {
            // Clear previous timeout if exists
            if (toastTimeout) clearTimeout(toastTimeout);

            // Set toast content and style
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            // Set icon based on type
            toastIcon.innerHTML = '';
            let iconPath = '';
            let iconColor = 'text-blue-500';

            switch (type) {
                case 'success':
                    iconPath = 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z';
                    iconColor = 'text-green-500';
                    break;
                case 'error':
                    iconPath = 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z';
                    iconColor = 'text-red-500';
                    break;
                case 'warning':
                    iconPath = 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z';
                    iconColor = 'text-yellow-500';
                    break;
                default:
                    iconPath = 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
                    break;
            }

            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            icon.setAttribute('class', `h-6 w-6 ${iconColor}`);
            icon.setAttribute('fill', 'none');
            icon.setAttribute('viewBox', '0 0 24 24');
            icon.setAttribute('stroke', 'currentColor');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke-linecap', 'round');
            path.setAttribute('stroke-linejoin', 'round');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('d', iconPath);

            icon.appendChild(path);
            toastIcon.appendChild(icon);

            // Show toast with animation
            toast.classList.remove('hidden');
            gsap.from(toast, {
                duration: 0.3,
                opacity: 0,
                y: 20,
                ease: "back.out(1.7)"
            });

            // Hide after 5 seconds
            toastTimeout = setTimeout(() => {
                hideToast();
            }, 5000);
        }

        // Hide toast notification
        function hideToast() {
            gsap.to(toast, {
                duration: 0.2,
                opacity: 0,
                y: 10,
                ease: "power2.in",
                onComplete: () => {
                    toast.classList.add('hidden');
                }
            });
        }

        // Format time
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Generate session ID
        function getCurrentSessionId() {
            if (!activeSection) return '';
            const today = new Date().toISOString().split('T')[0];
            return `${activeSection.id}_${today}`;
        }

        // Generate color from string
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') ||
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
        }

        // Initialize the app
        initTheme();
        init();
    </script>
</body>

</html>