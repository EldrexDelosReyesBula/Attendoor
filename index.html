<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fingerprintjs2@2.1.4/dist/fingerprint2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --systemBlue: #0A84FF;
            --systemBlueLight: rgba(10, 132, 255, 0.1);
            --systemGreen: #30D158;
            --systemGreenLight: rgba(48, 209, 88, 0.1);
            --systemRed: #FF453A;
            --systemRedLight: rgba(255, 69, 58, 0.1);
            --systemOrange: #FF9F0A;
            --systemOrangeLight: rgba(255, 159, 10, 0.1);
            --systemPurple: #BF5AF2;
            --systemPurpleLight: rgba(191, 90, 242, 0.1);
            --systemGray: #8E8E93;
            --systemGray2: #636366;
            --systemGray6: #F2F2F7;
            --labelPrimary: #000000;
            --labelSecondary: #3C3C4399;
            --backgroundPrimary: #FFFFFF;
            --backgroundSecondary: #F2F2F7;
            --shadowColor: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--backgroundSecondary);
            color: var(--labelPrimary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--backgroundPrimary);
            min-height: 100vh;
            box-shadow: 0 0 20px var(--shadowColor);
        }

        header {
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--systemBlue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background-color: var(--systemBlue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .nav-button {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--systemBlue);
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-button:active {
            background-color: var(--systemBlueLight);
            transform: scale(0.96);
        }

        .card {
            background-color: var(--backgroundPrimary);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadowColor);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.4, 1);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadowColor);
        }

        .card:active {
            transform: scale(0.98) translateY(0);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--labelSecondary);
            margin-top: 4px;
        }

        .button {
            background-color: var(--systemBlue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
            position: relative;
            overflow: hidden;
        }

        .button:disabled {
            background-color: var(--systemGray);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button:active:not(:disabled) {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .button-success {
            background-color: var(--systemGreen);
        }

        .button-danger {
            background-color: var(--systemRed);
        }

        .button-warning {
            background-color: var(--systemOrange);
        }

        .button-secondary {
            background-color: var(--systemGray6);
            color: var(--labelPrimary);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--systemGreen);
            box-shadow: 0 0 0 2px var(--systemGreenLight);
        }

        .status-inactive {
            background-color: var(--systemGray);
            box-shadow: 0 0 0 2px rgba(142, 142, 147, 0.1);
        }

        .status-pending {
            background-color: var(--systemOrange);
            box-shadow: 0 0 0 2px var(--systemOrangeLight);
        }

        .attendance-time {
            font-size: 16px;
            font-weight: 500;
            margin: 20px 0;
            text-align: center;
        }

        .progress-container {
            height: 5px;
            background-color: var(--systemGray6);
            border-radius: 2.5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--systemBlue);
            border-radius: 2.5px;
            transition: width 0.3s ease-out;
        }

        .tab-bar {
            display: flex;
            background-color: var(--backgroundPrimary);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadowColor);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--labelSecondary);
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
            cursor: pointer;
        }

        .tab.active {
            background-color: var(--systemBlue);
            color: white;
            font-weight: 600;
        }

        .attendance-history {
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--systemGray6);
            transition: all 0.2s ease;
        }

        .history-item:active {
            background-color: var(--systemGray6);
        }

        .history-date {
            font-weight: 500;
        }

        .history-status {
            font-weight: 500;
        }

        .status-present {
            color: var(--systemGreen);
        }

        .status-absent {
            color: var(--systemRed);
        }

        .status-late {
            color: var(--systemOrange);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--backgroundPrimary);
            width: 90%;
            max-width: 400px;
            border-radius: 14px;
            padding: 20px;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-icon {
            width: 24px;
            height: 24px;
            background-color: var(--systemBlue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--labelSecondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--labelPrimary);
            transform: rotate(90deg);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--labelSecondary);
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--systemGray6);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s ease;
            background-color: var(--backgroundPrimary);
        }

        .input-field:focus {
            border-color: var(--systemBlue);
            outline: none;
            box-shadow: 0 0 0 2px var(--systemBlueLight);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90%;
        }

        .toast-icon {
            font-size: 16px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: var(--systemBlue);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .user-name {
            font-weight: 500;
            font-size: 16px;
        }

        .user-role {
            font-size: 14px;
            color: var(--labelSecondary);
            margin-top: 2px;
        }

        .permission-card {
            background-color: var(--systemGray6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .permission-card:active {
            transform: scale(0.98);
        }

        .permission-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .permission-title {
            font-weight: 500;
            flex: 1;
        }

        .permission-toggle {
            width: 40px;
            height: 24px;
            border-radius: 12px;
            background-color: var(--systemGray);
            position: relative;
            transition: all 0.3s ease;
        }

        .permission-toggle.active {
            background-color: var(--systemGreen);
        }

        .permission-toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            border-radius: 10px;
            background-color: white;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .permission-toggle.active .permission-toggle-knob {
            left: 18px;
        }

        .permission-description {
            font-size: 13px;
            color: var(--labelSecondary);
            margin-top: 5px;
        }

        .permission-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .permission-card.expanded .permission-details {
            max-height: 200px;
            margin-top: 10px;
        }

        .student-list {
            margin-top: 15px;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--systemGray6);
        }

        .student-avatar {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            background-color: var(--systemPurple);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            margin-right: 10px;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 500;
            font-size: 14px;
        }

        .student-email {
            font-size: 12px;
            color: var(--labelSecondary);
        }

        .student-actions {
            display: flex;
            gap: 5px;
        }

        .action-button {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--systemGray6);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button:active {
            transform: scale(0.9);
        }

        .action-button.warning {
            background-color: var(--systemOrangeLight);
            color: var(--systemOrange);
        }

        .action-button.danger {
            background-color: var(--systemRedLight);
            color: var(--systemRed);
        }

        .share-link-container {
            display: flex;
            margin-top: 15px;
            border: 1px solid var(--systemGray6);
            border-radius: 10px;
            overflow: hidden;
        }

        .share-link {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border: none;
            background-color: var(--systemGray6);
            color: var(--labelPrimary);
        }

        .share-button {
            padding: 0 15px;
            background-color: var(--systemBlue);
            color: white;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-button:active {
            opacity: 0.8;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--systemGray6);
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-value {
            color: var(--labelSecondary);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--systemGray);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--systemBlue);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Physics-based animations */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Spring animation for buttons */
        @keyframes spring {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .spring-animation {
            animation: spring 0.4s cubic-bezier(0.2, 0.8, 0.4, 1.5);
        }

        /* Floating animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Bounce animation */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce-animation {
            animation: bounce 0.8s cubic-bezier(0.2, 0.8, 0.4, 1) infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .button {
                padding: 10px 15px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --labelPrimary: #FFFFFF;
                --labelSecondary: #EBEBF599;
                --backgroundPrimary: #1C1C1E;
                --backgroundSecondary: #000000;
                --systemGray6: #2C2C2E;
                --shadowColor: rgba(0, 0, 0, 0.3);
            }

            .input-field {
                background-color: var(--backgroundPrimary);
                border-color: var(--systemGray6);
                color: white;
            }

            .button-secondary {
                background-color: var(--systemGray6);
                color: var(--labelPrimary);
            }

            .permission-card {
                background-color: rgba(44, 44, 46, 0.5);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">SA</div>
                SecureAttend
            </div>
            <button class="nav-button" id="authButton">Sign In</button>
        </header>

        <div id="authSection">
            <div class="card floating" style="text-align: center; padding: 30px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üì±</div>
                <div class="card-title" style="font-size: 24px; margin-bottom: 10px;">Welcome to SecureAttend</div>
                <div class="card-subtitle" style="margin-bottom: 20px;">Secure, privacy-focused attendance system</div>
                <button class="button" id="getStartedBtn">Get Started</button>
            </div>
        </div>

        <div id="appSection" style="display: none;">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div class="user-name" id="userName">User Name</div>
                    <div class="user-role" id="userRole">Student</div>
                </div>
            </div>

            <div class="tab-bar">
                <div class="tab active" data-tab="checkin">Check In</div>
                <div class="tab" data-tab="history">History</div>
                <div class="tab" data-tab="messages">Messages</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <div id="checkinTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Morning Session</div>
                            <div class="card-subtitle">Available until 10:00 AM</div>
                        </div>
                        <div><span class="status-indicator status-inactive"></span></div>
                    </div>
                    <div class="attendance-time" id="morningTime">--:--</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="morningProgress" style="width: 0%"></div>
                    </div>
                    <button class="button" id="morningCheckinBtn" disabled>Check In</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Afternoon Session</div>
                            <div class="card-subtitle">Available until 4:00 PM</div>
                        </div>
                        <div><span class="status-indicator status-inactive"></span></div>
                    </div>
                    <div class="attendance-time" id="afternoonTime">--:--</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="afternoonProgress" style="width: 0%"></div>
                    </div>
                    <button class="button" id="afternoonCheckinBtn" disabled>Check In</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Location Verification</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Current Location</label>
                        <input type="text" class="input-field" id="locationInput" placeholder="Acquiring location..." readonly>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Distance from Class</label>
                        <input type="text" class="input-field" id="distanceInput" placeholder="Calculating..." readonly>
                    </div>
                </div>
            </div>

            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Attendance History</div>
                    </div>
                    <div class="attendance-history" id="attendanceHistory">
                        <div class="history-item">
                            <div class="history-date">Loading...</div>
                            <div class="history-status">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messagesTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Messages</div>
                    </div>
                    <div id="messagesList">
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No messages yet
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 15px;">
                        <label class="input-label">New Message</label>
                        <textarea class="input-field" id="messageInput" placeholder="Type your message..." rows="3"></textarea>
                    </div>
                    <button class="button" id="sendMessageBtn">Send</button>
                </div>
            </div>

            <div id="settingsTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Privacy & Permissions</div>
                    </div>
                    
                    <div class="permission-card" id="locationPermissionCard">
                        <div class="permission-header">
                            <div class="permission-title">Location Access</div>
                            <div class="permission-toggle" id="locationToggle">
                                <div class="permission-toggle-knob"></div>
                            </div>
                        </div>
                        <div class="permission-description">
                            Required for accurate attendance verification
                        </div>
                        <div class="permission-details">
                            <p style="font-size: 13px; color: var(--labelSecondary); margin-top: 10px;">
                                SecureAttend uses your location to verify you're physically present in class. 
                                We only access your location during check-in and don't store your precise location long-term.
                            </p>
                        </div>
                    </div>
                    
                    <div class="permission-card" id="notificationsPermissionCard">
                        <div class="permission-header">
                            <div class="permission-title">Notifications</div>
                            <div class="permission-toggle" id="notificationsToggle">
                                <div class="permission-toggle-knob"></div>
                            </div>
                        </div>
                        <div class="permission-description">
                            Get reminders and important updates
                        </div>
                        <div class="permission-details">
                            <p style="font-size: 13px; color: var(--labelSecondary); margin-top: 10px;">
                                We'll send you reminders for upcoming classes and important announcements. 
                                You can customize notification preferences in your device settings.
                            </p>
                        </div>
                    </div>
                    
                    <div class="permission-card" id="cameraPermissionCard">
                        <div class="permission-header">
                            <div class="permission-title">Camera Access</div>
                            <div class="permission-toggle" id="cameraToggle">
                                <div class="permission-toggle-knob"></div>
                            </div>
                        </div>
                        <div class="permission-description">
                            Optional for photo verification (coming soon)
                        </div>
                        <div class="permission-details">
                            <p style="font-size: 13px; color: var(--labelSecondary); margin-top: 10px;">
                                Future versions may allow photo verification for attendance. Currently not used.
                            </p>
                        </div>
                    </div>
                    
                    <button class="button button-secondary" style="margin-top: 15px;" id="reportBugBtn">
                        Report a Bug or Issue
                    </button>
                    
                    <button class="button button-danger" style="margin-top: 15px;" id="logoutBtn">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>

        <div id="teacherSection" style="display: none;">
            <div class="user-info">
                <div class="avatar" id="teacherAvatar">T</div>
                <div>
                    <div class="user-name" id="teacherName">Teacher Name</div>
                    <div class="user-role">Teacher</div>
                </div>
            </div>

            <div class="tab-bar">
                <div class="tab active" data-tab="teacherClass">Class</div>
                <div class="tab" data-tab="teacherStudents">Students</div>
                <div class="tab" data-tab="teacherSettings">Settings</div>
            </div>

            <div id="teacherClassTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Class Information</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Class Name</label>
                        <input type="text" class="input-field" id="classNameInput" placeholder="Enter class name">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Class Location</label>
                        <input type="text" class="input-field" id="classLocationInput" placeholder="Search for location...">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Allowed Distance (meters)</label>
                        <input type="number" class="input-field" id="classDistanceInput" placeholder="200" value="200">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Morning Session</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="input-field" id="morningStartInput" style="flex: 1;">
                                <option value="7">7:00 AM</option>
                                <option value="8">8:00 AM</option>
                                <option value="9">9:00 AM</option>
                            </select>
                            <select class="input-field" id="morningEndInput" style="flex: 1;">
                                <option value="10">10:00 AM</option>
                                <option value="11">11:00 AM</option>
                                <option value="12">12:00 PM</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Afternoon Session</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="input-field" id="afternoonStartInput" style="flex: 1;">
                                <option value="13">1:00 PM</option>
                                <option value="14">2:00 PM</option>
                                <option value="15">3:00 PM</option>
                            </select>
                            <select class="input-field" id="afternoonEndInput" style="flex: 1;">
                                <option value="16">4:00 PM</option>
                                <option value="17">5:00 PM</option>
                                <option value="18">6:00 PM</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="button" id="saveClassBtn">Save Changes</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Invite Students</div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Invitation Link</label>
                        <div class="share-link-container">
                            <input type="text" class="share-link" id="inviteLinkInput" readonly>
                            <button class="share-button" id="copyInviteLinkBtn">Copy</button>
                        </div>
                    </div>
                    
                    <p style="font-size: 13px; color: var(--labelSecondary); margin-top: 10px;">
                        Share this link with your students. When they sign up using this link, 
                        they'll automatically be added to your class.
                    </p>
                </div>
            </div>

            <div id="teacherStudentsTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Student Management</div>
                    </div>
                    
                    <div class="student-list" id="studentList">
                        <div class="student-item">
                            <div class="student-avatar">LD</div>
                            <div class="student-info">
                                <div class="student-name">Loading students...</div>
                                <div class="student-email">Please wait</div>
                            </div>
                            <div class="student-actions">
                                <button class="action-button warning">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                </button>
                                <button class="action-button danger">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="teacherSettingsTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Teacher Settings</div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-label">Require Location</div>
                        <label class="switch">
                            <input type="checkbox" id="requireLocationToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-label">Allow Remote Check-in</div>
                        <label class="switch">
                            <input type="checkbox" id="allowRemoteToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-label">Attendance Notifications</div>
                        <label class="switch">
                            <input type="checkbox" id="attendanceNotificationsToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-label">Default Check-in Method</div>
                        <select class="input-field" id="checkinMethodSelect" style="margin-top: 5px;">
                            <option value="button">Button Click</option>
                            <option value="fingerprint">Fingerprint</option>
                            <option value="both">Both Required</option>
                        </select>
                    </div>
                    
                    <button class="button button-secondary" style="margin-top: 15px;" id="teacherReportBtn">
                        Report Issues
                    </button>
                    
                    <button class="button button-danger" style="margin-top: 15px;" id="teacherLogoutBtn">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Admin Dashboard</div>
                </div>
                <button class="button" id="manageClassesBtn">Manage Classes</button>
                <button class="button" style="margin-top: 10px;" id="exportDataBtn">Export Attendance Data</button>
                <button class="button button-danger" style="margin-top: 10px;" id="adminLogoutBtn">Log Out</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="modal-close" id="closeAuthModal">&times;</button>
            <div class="modal-title">
                <div class="modal-icon" id="authModalIcon">{isSignUp ? 'üë©‚Äçüè´' : 'üîí'}</div>
                <span id="authModalTitle">Sign In</span>
            </div>
            <div class="input-group">
                <label class="input-label">Email</label>
                <input type="email" class="input-field" id="modalEmailInput" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <input type="password" class="input-field" id="modalPasswordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="input-group" id="confirmPasswordGroup" style="display: none;">
                <label class="input-label">Confirm Password</label>
                <input type="password" class="input-field" id="modalConfirmPasswordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="input-group" id="nameGroup" style="display: none;">
                <label class="input-label">Full Name</label>
                <input type="text" class="input-field" id="modalNameInput" placeholder="Your Name">
            </div>
            <div class="input-group" id="teacherCodeGroup" style="display: none;">
                <label class="input-label">Teacher Code (optional)</label>
                <input type="text" class="input-field" id="modalTeacherCodeInput" placeholder="If you're a teacher">
            </div>
            <button class="button" id="modalAuthButton">Sign In</button>
            <div style="text-align: center; margin-top: 15px;">
                <button class="nav-button" id="modalToggleAuth">Create Account Instead</button>
            </div>
        </div>
    </div>

    <!-- Teacher Registration Modal -->
    <div class="modal" id="teacherModal">
        <div class="modal-content">
            <button class="modal-close" id="closeTeacherModal">&times;</button>
            <div class="modal-title">
                <div class="modal-icon">üë©‚Äçüè´</div>
                <span>Become a Teacher</span>
            </div>
            <div class="input-group">
                <label class="input-label">Institution Name</label>
                <input type="text" class="input-field" id="teacherInstitutionInput" placeholder="School or Organization">
            </div>
            <div class="input-group">
                <label class="input-label">Verification Email</label>
                <input type="email" class="input-field" id="teacherEmailInput" placeholder="Institutional email preferred">
            </div>
            <div class="input-group">
                <label class="input-label">Create Teacher Code</label>
                <input type="text" class="input-field" id="teacherCodeCreateInput" placeholder="Secure code for future access">
            </div>
            <p style="font-size: 13px; color: var(--labelSecondary); margin-bottom: 15px;">
                As a teacher, you'll be able to create classes, manage students, and track attendance.
                You'll receive a confirmation email with next steps.
            </p>
            <button class="button" id="registerTeacherBtn">Register as Teacher</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <button class="modal-close" id="closeReportModal">&times;</button>
            <div class="modal-title">
                <div class="modal-icon">üêû</div>
                <span>Report an Issue</span>
            </div>
            <div class="input-group">
                <label class="input-label">What happened?</label>
                <select class="input-field" id="reportTypeInput">
                    <option value="bug">Bug or Error</option>
                    <option value="feature">Feature Request</option>
                    <option value="security">Security Concern</option>
                    <option value="other">Other Issue</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Description</label>
                <textarea class="input-field" id="reportDescriptionInput" rows="4" placeholder="Please describe the issue in detail..."></textarea>
            </div>
            <p style="font-size: 13px; color: var(--labelSecondary); margin-bottom: 15px;">
                Reports will be sent to our support team at eldrexdelosreyesbula@gmail.com.
                We appreciate your feedback to improve SecureAttend.
            </p>
            <button class="button" id="submitReportBtn">Submit Report</button>
        </div>
    </div>

    <!-- Permission Explanation Modal -->
    <div class="modal" id="permissionModal">
        <div class="modal-content">
            <button class="modal-close" id="closePermissionModal">&times;</button>
            <div class="modal-title">
                <div class="modal-icon" id="permissionModalIcon">üîí</div>
                <span id="permissionModalTitle">Permission Required</span>
            </div>
            <div id="permissionModalContent">
                <p style="margin-bottom: 15px; color: var(--labelPrimary);">
                    SecureAttend needs your permission to access <strong id="permissionName">this feature</strong>.
                </p>
                <p style="margin-bottom: 15px; color: var(--labelSecondary);">
                    <span id="permissionReason">This is required for core functionality.</span>
                    We respect your privacy and only use this data when necessary.
                </p>
                <div class="card" style="background-color: var(--systemGray6); margin-bottom: 15px;">
                    <div style="font-size: 13px; color: var(--labelSecondary);">
                        <strong>How we use this:</strong>
                        <ul style="margin-top: 5px; padding-left: 20px;">
                            <li id="permissionUse1">Feature functionality</li>
                            <li id="permissionUse2">Security verification</li>
                            <li id="permissionUse3">No unnecessary data collection</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="button button-secondary" style="flex: 1;" id="denyPermissionBtn">
                    Not Now
                </button>
                <button class="button" style="flex: 1;" id="grantPermissionBtn">
                    Allow
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚ÑπÔ∏è</span>
        <span id="toastMessage">Notification message</span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVP8zaUj2iDrooLbRQNypHqB8QNTLhGDE",
            authDomain: "attendance-fe1c8.firebaseapp.com",
            projectId: "attendance-fe1c8",
            storageBucket: "attendance-fe1c8.firebasestorage.app",
            messagingSenderId: "903463376704",
            appId: "1:903463376704:web:d004c563d56aa286df8ca5",
            measurementId: "G-YY5GQZPSRK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Encryption key (in a real app, this would be user-specific and securely stored)
        const ENCRYPTION_KEY = "secure-attend-enc-key-2023";

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const teacherSection = document.getElementById('teacherSection');
        const adminSection = document.getElementById('adminSection');
        const authButton = document.getElementById('authButton');
        const getStartedBtn = document.getElementById('getStartedBtn');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const teacherName = document.getElementById('teacherName');
        const teacherAvatar = document.getElementById('teacherAvatar');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const morningCheckinBtn = document.getElementById('morningCheckinBtn');
        const afternoonCheckinBtn = document.getElementById('afternoonCheckinBtn');
        const morningTime = document.getElementById('morningTime');
        const afternoonTime = document.getElementById('afternoonTime');
        const morningProgress = document.getElementById('morningProgress');
        const afternoonProgress = document.getElementById('afternoonProgress');
        const locationInput = document.getElementById('locationInput');
        const distanceInput = document.getElementById('distanceInput');
        const attendanceHistory = document.getElementById('attendanceHistory');
        const messagesList = document.getElementById('messagesList');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const authModal = document.getElementById('authModal');
        const teacherModal = document.getElementById('teacherModal');
        const reportModal = document.getElementById('reportModal');
        const permissionModal = document.getElementById('permissionModal');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const closeTeacherModal = document.getElementById('closeTeacherModal');
        const closeReportModal = document.getElementById('closeReportModal');
        const closePermissionModal = document.getElementById('closePermissionModal');
        const modalAuthButton = document.getElementById('modalAuthButton');
        const modalToggleAuth = document.getElementById('modalToggleAuth');
        const modalEmailInput = document.getElementById('modalEmailInput');
        const modalPasswordInput = document.getElementById('modalPasswordInput');
        const modalConfirmPasswordInput = document.getElementById('modalConfirmPasswordInput');
        const modalNameInput = document.getElementById('modalNameInput');
        const modalTeacherCodeInput = document.getElementById('modalTeacherCodeInput');
        const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
        const nameGroup = document.getElementById('nameGroup');
        const teacherCodeGroup = document.getElementById('teacherCodeGroup');
        const authModalTitle = document.getElementById('authModalTitle');
        const authModalIcon = document.getElementById('authModalIcon');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        const reportBugBtn = document.getElementById('reportBugBtn');
        const teacherReportBtn = document.getElementById('teacherReportBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const teacherLogoutBtn = document.getElementById('teacherLogoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const registerTeacherBtn = document.getElementById('registerTeacherBtn');
        const reportTypeInput = document.getElementById('reportTypeInput');
        const reportDescriptionInput = document.getElementById('reportDescriptionInput');
        const submitReportBtn = document.getElementById('submitReportBtn');
        const permissionModalTitle = document.getElementById('permissionModalTitle');
        const permissionModalIcon = document.getElementById('permissionModalIcon');
        const permissionModalContent = document.getElementById('permissionModalContent');
        const permissionName = document.getElementById('permissionName');
        const permissionReason = document.getElementById('permissionReason');
        const permissionUse1 = document.getElementById('permissionUse1');
        const permissionUse2 = document.getElementById('permissionUse2');
        const permissionUse3 = document.getElementById('permissionUse3');
        const grantPermissionBtn = document.getElementById('grantPermissionBtn');
        const denyPermissionBtn = document.getElementById('denyPermissionBtn');
        const locationToggle = document.getElementById('locationToggle');
        const notificationsToggle = document.getElementById('notificationsToggle');
        const cameraToggle = document.getElementById('cameraToggle');
        const locationPermissionCard = document.getElementById('locationPermissionCard');
        const notificationsPermissionCard = document.getElementById('notificationsPermissionCard');
        const cameraPermissionCard = document.getElementById('cameraPermissionCard');
        const studentList = document.getElementById('studentList');
        const classNameInput = document.getElementById('classNameInput');
        const classLocationInput = document.getElementById('classLocationInput');
        const classDistanceInput = document.getElementById('classDistanceInput');
        const morningStartInput = document.getElementById('morningStartInput');
        const morningEndInput = document.getElementById('morningEndInput');
        const afternoonStartInput = document.getElementById('afternoonStartInput');
        const afternoonEndInput = document.getElementById('afternoonEndInput');
        const saveClassBtn = document.getElementById('saveClassBtn');
        const inviteLinkInput = document.getElementById('inviteLinkInput');
        const copyInviteLinkBtn = document.getElementById('copyInviteLinkBtn');
        const requireLocationToggle = document.getElementById('requireLocationToggle');
        const allowRemoteToggle = document.getElementById('allowRemoteToggle');
        const attendanceNotificationsToggle = document.getElementById('attendanceNotificationsToggle');
        const checkinMethodSelect = document.getElementById('checkinMethodSelect');
        const teacherInstitutionInput = document.getElementById('teacherInstitutionInput');
        const teacherEmailInput = document.getElementById('teacherEmailInput');
        const teacherCodeCreateInput = document.getElementById('teacherCodeCreateInput');

        // Global Variables
        let isSignUp = false;
        let currentUser = null;
        let userData = null;
        let deviceFingerprint = null;
        let currentLocation = null;
        let classLocation = { lat: 37.7749, lng: -122.4194 }; // Default to San Francisco
        let morningSession = { start: 7, end: 10 }; // 7AM to 10AM
        let afternoonSession = { start: 13, end: 16 }; // 1PM to 4PM
        let requestedPermission = null;
        let permissionCallbacks = {};
        let classData = null;
        let geocoder = null;
        let permissions = {
            location: false,
            notifications: false,
            camera: false
        };

        // Initialize IndexedDB for offline support
        let dbPromise;
        if ('indexedDB' in window) {
            dbPromise = new Promise((resolve, reject) => {
                const request = indexedDB.open('SecureAttendDB', 2);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('attendance')) {
                        db.createObjectStore('attendance', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('messages')) {
                        db.createObjectStore('messages', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            getDeviceFingerprint();
            loadOfflineData();
            loadPermissions();
            
            // Check network status
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Initialize tabs
            switchTab('checkin');
            
            // Initialize geocoder if available
            if (typeof google !== 'undefined') {
                geocoder = new google.maps.Geocoder();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth buttons
            authButton.addEventListener('click', handleAuthButtonClick);
            getStartedBtn.addEventListener('click', () => authModal.classList.add('active'));
            
            // Modal auth
            closeAuthModal.addEventListener('click', () => authModal.classList.remove('active'));
            modalAuthButton.addEventListener('click', handleModalAuth);
            modalToggleAuth.addEventListener('click', toggleAuthMode);
            
            // Teacher modal
            closeTeacherModal.addEventListener('click', () => teacherModal.classList.remove('active'));
            registerTeacherBtn.addEventListener('click', registerTeacher);
            
            // Report modal
            closeReportModal.addEventListener('click', () => reportModal.classList.remove('active'));
            reportBugBtn.addEventListener('click', () => {
                reportModal.classList.add('active');
                reportTypeInput.value = 'bug';
            });
            teacherReportBtn.addEventListener('click', () => {
                reportModal.classList.add('active');
                reportTypeInput.value = 'feature';
            });
            submitReportBtn.addEventListener('click', submitReport);
            
            // Permission modal
            closePermissionModal.addEventListener('click', () => permissionModal.classList.remove('active'));
            grantPermissionBtn.addEventListener('click', grantPermission);
            denyPermissionBtn.addEventListener('click', denyPermission);
            
            // Permission cards
            locationPermissionCard.addEventListener('click', () => requestPermission('location'));
            notificationsPermissionCard.addEventListener('click', () => requestPermission('notifications'));
            cameraPermissionCard.addEventListener('click', () => requestPermission('camera'));
            
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    if (tabName.startsWith('teacher')) {
                        switchTeacherTab(tabName.replace('teacher', '').toLowerCase());
                    } else {
                        switchTab(tabName);
                    }
                });
            });
            
            // Check-in buttons
            morningCheckinBtn.addEventListener('click', () => checkIn('morning'));
            afternoonCheckinBtn.addEventListener('click', () => checkIn('afternoon'));
            
            // Messages
            sendMessageBtn.addEventListener('click', sendMessage);
            
            // Teacher functions
            saveClassBtn.addEventListener('click', saveClassSettings);
            copyInviteLinkBtn.addEventListener('click', copyInviteLink);
            
            // Logout buttons
            logoutBtn.addEventListener('click', signOut);
            teacherLogoutBtn.addEventListener('click', signOut);
            adminLogoutBtn.addEventListener('click', signOut);
            
            // Ripple effect for buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('button') || e.target.classList.contains('nav-button')) {
                    createRipple(e);
                }
            });
            
            // Permission toggles
            locationToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                requestPermission('location');
            });
            
            notificationsToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                requestPermission('notifications');
            });
            
            cameraToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                requestPermission('camera');
            });
            
            // Expand permission cards
            [locationPermissionCard, notificationsPermissionCard, cameraPermissionCard].forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target === this || e.target.classList.contains('permission-header')) {
                        this.classList.toggle('expanded');
                    }
                });
            });
        }

        function handleAuthButtonClick() {
            if (currentUser) {
                // Show confirmation before logout
                showConfirmDialog(
                    "Sign Out", 
                    "Are you sure you want to sign out?", 
                    "You'll need to sign in again to use SecureAttend.",
                    signOut,
                    () => {}
                );
            } else {
                authModal.classList.add('active');
            }
        }

        // Authentication handlers
        function toggleAuthMode() {
            isSignUp = !isSignUp;
            confirmPasswordGroup.style.display = isSignUp ? 'block' : 'none';
            nameGroup.style.display = isSignUp ? 'block' : 'none';
            teacherCodeGroup.style.display = isSignUp ? 'block' : 'none';
            authModalTitle.textContent = isSignUp ? 'Create Account' : 'Sign In';
            authModalIcon.textContent = isSignUp ? 'üë©‚Äçüè´' : 'üîí';
            modalAuthButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            modalToggleAuth.textContent = isSignUp ? 'Sign In Instead' : 'Create Account';
        }

        async function handleModalAuth() {
            const email = modalEmailInput.value.trim();
            const password = modalPasswordInput.value.trim();
            const confirmPassword = modalConfirmPasswordInput.value.trim();
            const name = modalNameInput.value.trim();
            const teacherCode = modalTeacherCodeInput.value.trim();
            
            if (!email || !password) {
                showToast('Please enter email and password', '‚ö†Ô∏è');
                return;
            }
            
            if (isSignUp) {
                if (password !== confirmPassword) {
                    showToast('Passwords do not match', '‚ö†Ô∏è');
                    return;
                }
                if (!name) {
                    showToast('Please enter your name', '‚ö†Ô∏è');
                    return;
                }
                await signUp(email, password, name, teacherCode);
            } else {
                await signIn(email, password);
            }
        }

        async function signIn(email, password) {
            try {
                modalAuthButton.disabled = true;
                modalAuthButton.innerHTML = '<div class="loading"></div>';
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Set session cookie
                Cookies.set('secureAttendSession', 'active', { expires: 7, secure: true, sameSite: 'strict' });
                
                showToast('Signed in successfully', '‚úÖ');
                authModal.classList.remove('active');
                loadUserData();
            } catch (error) {
                console.error('Sign in error:', error);
                showToast(error.message, '‚ùå');
            } finally {
                modalAuthButton.disabled = false;
                modalAuthButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            }
        }

        async function signUp(email, password, name, teacherCode) {
            try {
                modalAuthButton.disabled = true;
                modalAuthButton.innerHTML = '<div class="loading"></div>';
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Encrypt sensitive data
                const encryptedName = encryptData(name);
                
                // Create user document in Firestore
                const userData = {
                    email: email,
                    name: encryptedName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Check if teacher code is valid
                if (teacherCode) {
                    const teacherDoc = await db.collection('teachers').where('code', '==', teacherCode).limit(1).get();
                    if (!teacherDoc.empty) {
                        userData.role = 'teacher';
                        userData.teacherId = teacherDoc.docs[0].id;
                        userData.classId = teacherDoc.docs[0].data().classId;
                    }
                }
                
                await db.collection('users').doc(userCredential.user.uid).set(userData);
                
                // Set session cookie
                Cookies.set('secureAttendSession', 'active', { expires: 7, secure: true, sameSite: 'strict' });
                
                showToast('Account created successfully', '‚úÖ');
                authModal.classList.remove('active');
                loadUserData();
                
                // Clear form
                modalEmailInput.value = '';
                modalPasswordInput.value = '';
                modalConfirmPasswordInput.value = '';
                modalNameInput.value = '';
                modalTeacherCodeInput.value = '';
                toggleAuthMode();
            } catch (error) {
                console.error('Sign up error:', error);
                showToast(error.message, '‚ùå');
            } finally {
                modalAuthButton.disabled = false;
                modalAuthButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            }
        }

        function signOut() {
            auth.signOut().then(() => {
                // Clear session cookie
                Cookies.remove('secureAttendSession');
                
                showToast('Signed out successfully', 'üëã');
                currentUser = null;
                userData = null;
                checkAuthState();
            }).catch(error => {
                console.error('Sign out error:', error);
                showToast(error.message, '‚ùå');
            });
        }

        // Check auth state
        function checkAuthState() {
            const sessionCookie = Cookies.get('secureAttendSession');
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    authButton.textContent = 'Sign Out';
                    loadUserData();
                    
                    // Check if we should show auth modal (cookie expired but Firebase session still valid)
                    if (!sessionCookie) {
                        Cookies.set('secureAttendSession', 'active', { expires: 7, secure: true, sameSite: 'strict' });
                    }
                } else {
                    currentUser = null;
                    userData = null;
                    
                    // Show auth modal if no session cookie exists
                    if (!sessionCookie) {
                        authSection.style.display = 'block';
                        appSection.style.display = 'none';
                        teacherSection.style.display = 'none';
                        adminSection.style.display = 'none';
                        authButton.textContent = 'Sign In';
                    } else {
                        // Cookie exists but no user - try to restore session
                        try {
                            await auth.signInWithEmailAndPassword('', '');
                        } catch (error) {
                            // Clear invalid cookie
                            Cookies.remove('secureAttendSession');
                            authSection.style.display = 'block';
                            appSection.style.display = 'none';
                            teacherSection.style.display = 'none';
                            adminSection.style.display = 'none';
                            authButton.textContent = 'Sign In';
                        }
                    }
                }
            });
        }

        // Load user data from Firestore
        async function loadUserData() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    userData = doc.data();
                    
                    // Decrypt encrypted fields
                    if (userData.name) {
                        userData.name = decryptData(userData.name);
                    }
                    
                    updateUI();
                    
                    if (userData.role === 'admin') {
                        appSection.style.display = 'none';
                        teacherSection.style.display = 'none';
                        adminSection.style.display = 'block';
                    } else if (userData.role === 'teacher') {
                        appSection.style.display = 'none';
                        teacherSection.style.display = 'block';
                        adminSection.style.display = 'none';
                        loadTeacherData();
                    } else {
                        appSection.style.display = 'block';
                        teacherSection.style.display = 'none';
                        adminSection.style.display = 'none';
                    }
                    
                    // Load class data if student is in a class
                    if (userData.classId) {
                        loadClassData(userData.classId);
                    }
                    
                    // Load attendance history
                    loadAttendanceHistory();
                    
                    // Load messages
                    loadMessages();
                    
                    // Request necessary permissions
                    requestInitialPermissions();
                    
                    // Update time displays
                    updateTimeDisplays();
                    setInterval(updateTimeDisplays, 1000);
                } else {
                    console.error('No user data found');
                    showToast('User data not found', '‚ö†Ô∏è');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading user data', '‚ùå');
            }
        }

        // Load teacher-specific data
        async function loadTeacherData() {
            try {
                // Check if teacher has a class
                const teacherDoc = await db.collection('teachers').doc(currentUser.uid).get();
                
                if (teacherDoc.exists) {
                    const teacherData = teacherDoc.data();
                    
                    // Load class data
                    if (teacherData.classId) {
                        classData = (await db.collection('classes').doc(teacherData.classId).get()).data();
                        
                        // Update UI with class data
                        classNameInput.value = classData.name || '';
                        classDistanceInput.value = classData.allowedDistance || 200;
                        morningStartInput.value = classData.morningSession?.start || 7;
                        morningEndInput.value = classData.morningSession?.end || 10;
                        afternoonStartInput.value = classData.afternoonSession?.start || 13;
                        afternoonEndInput.value = classData.afternoonSession?.end || 16;
                        
                        // Set location if available
                        if (classData.location) {
                            classLocation = {
                                lat: classData.location.latitude,
                                lng: classData.location.longitude
                            };
                            
                            // Get address for display
                            getAddressFromCoords(classLocation.lat, classLocation.lng)
                                .then(address => {
                                    classLocationInput.value = address;
                                });
                        }
                        
                        // Set invite link
                        inviteLinkInput.value = `${window.location.origin}${window.location.pathname}?class=${teacherData.classId}`;
                    }
                    
                    // Load students
                    loadStudents();
                }
            } catch (error) {
                console.error('Error loading teacher data:', error);
                showToast('Error loading teacher data', '‚ùå');
            }
        }

        // Load students for teacher
        async function loadStudents() {
            try {
                if (!userData?.classId) return;
                
                const studentsSnapshot = await db.collection('users')
                    .where('classId', '==', userData.classId)
                    .get();
                
                studentList.innerHTML = '';
                
                if (studentsSnapshot.empty) {
                    studentList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No students in this class yet
                        </div>
                    `;
                    return;
                }
                
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    
                    // Decrypt name if encrypted
                    if (student.name && typeof student.name === 'string' && student.name.startsWith('ENC:')) {
                        student.name = decryptData(student.name);
                    }
                    
                    const initials = student.name ? student.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '??';
                    
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.innerHTML = `
                        <div class="student-avatar">${initials}</div>
                        <div class="student-info">
                            <div class="student-name">${student.name || 'Unknown'}</div>
                            <div class="student-email">${student.email || 'No email'}</div>
                        </div>
                        <div class="student-actions">
                            <button class="action-button warning" data-id="${studentId}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                            </button>
                            <button class="action-button danger" data-id="${studentId}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    studentList.appendChild(studentItem);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.action-button.warning').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const studentId = btn.dataset.id;
                        showConfirmDialog(
                            "Disable Student", 
                            "Temporarily disable this student?", 
                            "The student won't be able to check in until you re-enable them.",
                            () => disableStudent(studentId),
                            () => {}
                        );
                    });
                });
                
                document.querySelectorAll('.action-button.danger').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const studentId = btn.dataset.id;
                        showConfirmDialog(
                            "Remove Student", 
                            "Permanently remove this student?", 
                            "This action cannot be undone. The student will need a new invite link to rejoin.",
                            () => removeStudent(studentId),
                            () => {}
                        );
                    });
                });
            } catch (error) {
                console.error('Error loading students:', error);
                studentList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                        Error loading students
                    </div>
                `;
            }
        }

        async function disableStudent(studentId) {
            try {
                await db.collection('users').doc(studentId).update({
                    disabled: true,
                    disabledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Student disabled', '‚úÖ');
                loadStudents();
            } catch (error) {
                console.error('Error disabling student:', error);
                showToast('Failed to disable student', '‚ùå');
            }
        }

        async function removeStudent(studentId) {
            try {
                await db.collection('users').doc(studentId).update({
                    classId: null,
                    removedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Student removed', '‚úÖ');
                loadStudents();
            } catch (error) {
                console.error('Error removing student:', error);
                showToast('Failed to remove student', '‚ùå');
            }
        }

        // Save class settings
        async function saveClassSettings() {
            try {
                if (!userData?.classId) return;
                
                saveClassBtn.disabled = true;
                saveClassBtn.innerHTML = '<div class="loading"></div>';
                
                const className = classNameInput.value.trim();
                const allowedDistance = parseInt(classDistanceInput.value) || 200;
                const morningStart = parseInt(morningStartInput.value) || 7;
                const morningEnd = parseInt(morningEndInput.value) || 10;
                const afternoonStart = parseInt(afternoonStartInput.value) || 13;
                const afternoonEnd = parseInt(afternoonEndInput.value) || 16;
                
                // Get location from input
                let location = classData?.location || null;
                if (classLocationInput.value.trim() && classLocationInput.value !== classData?.address) {
                    const coords = await getCoordsFromAddress(classLocationInput.value.trim());
                    if (coords) {
                        location = new firebase.firestore.GeoPoint(coords.lat, coords.lng);
                        classLocation = { lat: coords.lat, lng: coords.lng };
                    }
                }
                
                await db.collection('classes').doc(userData.classId).update({
                    name: className,
                    allowedDistance: allowedDistance,
                    location: location,
                    address: classLocationInput.value.trim(),
                    morningSession: {
                        start: morningStart,
                        end: morningEnd
                    },
                    afternoonSession: {
                        start: afternoonStart,
                        end: afternoonEnd
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Class settings saved', '‚úÖ');
            } catch (error) {
                console.error('Error saving class settings:', error);
                showToast('Failed to save settings', '‚ùå');
            } finally {
                saveClassBtn.disabled = false;
                saveClassBtn.textContent = 'Save Changes';
            }
        }

        // Copy invite link to clipboard
        function copyInviteLink() {
            inviteLinkInput.select();
            document.execCommand('copy');
            showToast('Invite link copied', 'üìã');
        }

        // Register as teacher
        async function registerTeacher() {
            try {
                const institution = teacherInstitutionInput.value.trim();
                const email = teacherEmailInput.value.trim();
                const code = teacherCodeCreateInput.value.trim();
                
                if (!institution || !email || !code) {
                    showToast('Please fill all fields', '‚ö†Ô∏è');
                    return;
                }
                
                if (code.length < 6) {
                    showToast('Teacher code must be at least 6 characters', '‚ö†Ô∏è');
                    return;
                }
                
                registerTeacherBtn.disabled = true;
                registerTeacherBtn.innerHTML = '<div class="loading"></div>';
                
                // Create a new class
                const classRef = await db.collection('classes').add({
                    name: `${institution} Class`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    teacherId: currentUser.uid
                });
                
                // Register as teacher
                await db.collection('teachers').doc(currentUser.uid).set({
                    institution: institution,
                    email: email,
                    code: code,
                    classId: classRef.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update user role
                await db.collection('users').doc(currentUser.uid).update({
                    role: 'teacher',
                    classId: classRef.id
                });
                
                // Update local user data
                userData.role = 'teacher';
                userData.classId = classRef.id;
                
                showToast('Teacher registration successful!', 'üéâ');
                teacherModal.classList.remove('active');
                
                // Reload UI
                updateUI();
                appSection.style.display = 'none';
                teacherSection.style.display = 'block';
                loadTeacherData();
            } catch (error) {
                console.error('Teacher registration error:', error);
                showToast(error.message, '‚ùå');
            } finally {
                registerTeacherBtn.disabled = false;
                registerTeacherBtn.textContent = 'Register as Teacher';
            }
        }

        // Submit report
        async function submitReport() {
            try {
                const type = reportTypeInput.value;
                const description = reportDescriptionInput.value.trim();
                
                if (!description) {
                    showToast('Please describe the issue', '‚ö†Ô∏è');
                    return;
                }
                
                submitReportBtn.disabled = true;
                submitReportBtn.innerHTML = '<div class="loading"></div>';
                
                // In a real app, you would send this to your backend
                // For this demo, we'll just show a confirmation
                
                // Simulate network request
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showToast('Report submitted successfully', '‚úÖ');
                reportModal.classList.remove('active');
                reportDescriptionInput.value = '';
            } catch (error) {
                console.error('Error submitting report:', error);
                showToast('Failed to submit report', '‚ùå');
            } finally {
                submitReportBtn.disabled = false;
                submitReportBtn.textContent = 'Submit Report';
            }
        }

        // Update UI with user data
        function updateUI() {
            if (!currentUser || !userData) return;
            
            const displayName = userData.name || currentUser.email.split('@')[0];
            const role = userData.role === 'admin' ? 'Administrator' : 
                        userData.role === 'teacher' ? 'Teacher' : 'Student';
            
            // Update student view
            userName.textContent = displayName;
            userRole.textContent = role;
            
            // Update teacher view
            teacherName.textContent = displayName;
            
            // Set avatar initials
            const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            userAvatar.textContent = initials;
            teacherAvatar.textContent = initials;
            
            // Update auth button
            authButton.textContent = 'Sign Out';
        }

        // Tab switching
        function switchTab(tabName) {
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabName}Tab`) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
        }

        function switchTeacherTab(tabName) {
            const teacherTabs = document.querySelectorAll('.tab[data-tab^="teacher"]');
            teacherTabs.forEach(tab => {
                if (tab.dataset.tab === `teacher${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            const teacherTabContents = document.querySelectorAll('#teacherSection .tab-content');
            teacherTabContents.forEach(content => {
                if (content.id === `teacher${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
        }

        // Device fingerprinting
        function getDeviceFingerprint() {
            return new Promise((resolve) => {
                if (typeof Fingerprint2 !== 'undefined') {
                    Fingerprint2.get(components => {
                        const values = components.map(component => component.value);
                        deviceFingerprint = Fingerprint2.x64hash128(values.join(''), 31);
                        console.log('Device fingerprint:', deviceFingerprint);
                        resolve(deviceFingerprint);
                    });
                } else {
                    console.warn('FingerprintJS not loaded');
                    // Fallback to simpler fingerprint
                    deviceFingerprint = 'fp-' + Math.random().toString(36).substring(2, 15);
                    resolve(deviceFingerprint);
                }
            });
        }

        // Location functions
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    error => {
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        async function getAddressFromCoords(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    return [
                        address.road || '',
                        address.house_number || '',
                        address.postcode || '',
                        address.city || address.town || address.village || '',
                        address.country || ''
                    ].filter(part => part).join(', ');
                }
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        async function getCoordsFromAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Calculate distance between two points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }

        // Time display and check-in availability
        function updateTimeDisplays() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Format current time
            const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Morning session
            if (currentHour >= morningSession.start && currentHour < morningSession.end) {
                // Within morning session
                const totalMinutes = (morningSession.end - morningSession.start) * 60;
                const elapsedMinutes = (currentHour - morningSession.start) * 60 + currentMinute;
                const progress = (elapsedMinutes / totalMinutes) * 100;
                
                morningTime.textContent = formattedTime;
                morningProgress.style.width = `${progress}%`;
                morningCheckinBtn.disabled = false;
                morningCheckinBtn.classList.add('button-success');
                document.querySelector('#checkinTab .card:nth-child(1) .status-indicator').className = 'status-indicator status-active';
            } else {
                // Outside morning session
                morningTime.textContent = formattedTime;
                morningProgress.style.width = '0%';
                morningCheckinBtn.disabled = true;
                morningCheckinBtn.classList.remove('button-success');
                document.querySelector('#checkinTab .card:nth-child(1) .status-indicator').className = 'status-indicator status-inactive';
            }
            
            // Afternoon session
            if (currentHour >= afternoonSession.start && currentHour < afternoonSession.end) {
                // Within afternoon session
                const totalMinutes = (afternoonSession.end - afternoonSession.start) * 60;
                const elapsedMinutes = (currentHour - afternoonSession.start) * 60 + currentMinute;
                const progress = (elapsedMinutes / totalMinutes) * 100;
                
                afternoonTime.textContent = formattedTime;
                afternoonProgress.style.width = `${progress}%`;
                afternoonCheckinBtn.disabled = false;
                afternoonCheckinBtn.classList.add('button-success');
                document.querySelector('#checkinTab .card:nth-child(2) .status-indicator').className = 'status-indicator status-active';
            } else {
                // Outside afternoon session
                afternoonTime.textContent = formattedTime;
                afternoonProgress.style.width = '0%';
                afternoonCheckinBtn.disabled = true;
                afternoonCheckinBtn.classList.remove('button-success');
                document.querySelector('#checkinTab .card:nth-child(2) .status-indicator').className = 'status-indicator status-inactive';
            }
        }

        // Check-in function
        async function checkIn(sessionType) {
            if (!currentUser || !userData || !deviceFingerprint) {
                showToast('Authentication required', '‚ö†Ô∏è');
                return;
            }
            
            if (userData.disabled) {
                showToast('Your account is disabled', '‚ùå');
                return;
            }
            
            // Verify permissions
            if (!permissions.location) {
                requestPermission('location');
                showToast('Location permission required', '‚ö†Ô∏è');
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const sessionTime = sessionType === 'morning' ? morningSession : afternoonSession;
            
            // Verify we're within the session time
            const currentHour = now.getHours();
            if (currentHour < sessionTime.start || currentHour >= sessionTime.end) {
                showToast(`Check-in not available outside ${sessionType} session`, '‚ö†Ô∏è');
                return;
            }
            
            try {
                // Get current location
                currentLocation = await getCurrentLocation();
                
                // Verify location (within allowed distance of class)
                const distance = calculateDistance(
                    currentLocation.lat, currentLocation.lng,
                    classLocation.lat, classLocation.lng
                );
                
                const allowedDistance = classData?.allowedDistance || 200;
                if (distance > allowedDistance) {
                    showToast(`You must be within ${allowedDistance}m of class to check in`, '‚ö†Ô∏è');
                    return;
                }
                
                // Disable button during check-in
                const button = sessionType === 'morning' ? morningCheckinBtn : afternoonCheckinBtn;
                button.disabled = true;
                button.innerHTML = '<div class="loading"></div>';
                
                // Create attendance record
                const attendanceData = {
                    userId: currentUser.uid,
                    userName: userData.name || currentUser.email,
                    classId: userData.classId || null,
                    session: sessionType,
                    date: today,
                    timestamp: now,
                    location: new firebase.firestore.GeoPoint(currentLocation.lat, currentLocation.lng),
                    deviceFingerprint: deviceFingerprint,
                    distance: Math.round(distance),
                    status: 'present'
                };
                
                // Check if already checked in today for this session
                const existingCheckIn = await db.collection('attendance')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', today)
                    .where('session', '==', sessionType)
                    .limit(1)
                    .get();
                
                if (!existingCheckIn.empty) {
                    showToast(`Already checked in for ${sessionType} session`, '‚ö†Ô∏è');
                    button.disabled = false;
                    button.textContent = 'Check In';
                    return;
                }
                
                // Add to Firestore
                await db.collection('attendance').add(attendanceData);
                
                // Add to offline storage
                await addToOfflineStorage('attendance', {
                    ...attendanceData,
                    id: `offline-${Date.now()}`,
                    synced: false
                });
                
                showToast(`${sessionType.charAt(0).toUpperCase() + sessionType.slice(1)} check-in successful!`, '‚úÖ');
                
                // Update UI
                button.disabled = true;
                button.textContent = 'Checked In';
                button.classList.remove('button-success');
                
                // Update location display
                getAddressFromCoords(currentLocation.lat, currentLocation.lng)
                    .then(address => {
                        locationInput.value = address;
                    });
                
                distanceInput.value = `${distance.toFixed(2)} meters`;
                
                // Reload history
                loadAttendanceHistory();
            } catch (error) {
                console.error('Check-in error:', error);
                showToast('Check-in failed: ' + error.message, '‚ùå');
                
                // Re-enable button
                const button = sessionType === 'morning' ? morningCheckinBtn : afternoonCheckinBtn;
                button.disabled = false;
                button.textContent = 'Check In';
            }
        }

        // Load attendance history
        async function loadAttendanceHistory() {
            if (!currentUser) return;
            
            try {
                let query;
                
                if (userData.role === 'student') {
                    query = db.collection('attendance')
                        .where('userId', '==', currentUser.uid)
                        .orderBy('date', 'desc')
                        .limit(30);
                } else if (userData.role === 'teacher' && userData.classId) {
                    query = db.collection('attendance')
                        .where('classId', '==', userData.classId)
                        .orderBy('date', 'desc')
                        .limit(50);
                } else {
                    return;
                }
                
                const snapshot = await query.get();
                
                // Also get offline attendance
                const offlineAttendance = await getOfflineData('attendance');
                const allAttendance = [
                    ...snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    ...offlineAttendance.filter(item => !item.synced)
                ];
                
                // Sort by date (newest first)
                allAttendance.sort((a, b) => b.date.toDate() - a.date.toDate());
                
                // Display in UI
                attendanceHistory.innerHTML = '';
                
                if (allAttendance.length === 0) {
                    attendanceHistory.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No attendance records yet
                        </div>
                    `;
                    return;
                }
                
                allAttendance.forEach(record => {
                    const date = record.date.toDate();
                    const formattedDate = date.toLocaleDateString([], { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    const formattedTime = record.timestamp.toDate().toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const statusClass = record.status === 'present' ? 'status-present' : 
                                      record.status === 'absent' ? 'status-absent' : 'status-late';
                    
                    const statusText = record.status === 'present' ? 'Present' : 
                                      record.status === 'absent' ? 'Absent' : 'Late';
                    
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    if (userData.role === 'teacher') {
                        item.innerHTML = `
                            <div class="history-date">
                                ${formattedDate} ‚Ä¢ ${record.userName || 'Unknown'}
                            </div>
                            <div class="history-status ${statusClass}">
                                ${statusText} ‚Ä¢ ${record.session} ‚Ä¢ ${formattedTime}
                            </div>
                        `;
                    } else {
                        item.innerHTML = `
                            <div class="history-date">
                                ${formattedDate} ‚Ä¢ ${record.session.charAt(0).toUpperCase() + record.session.slice(1)}
                            </div>
                            <div class="history-status ${statusClass}">
                                ${statusText} ‚Ä¢ ${formattedTime}
                            </div>
                        `;
                    }
                    
                    attendanceHistory.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading attendance history:', error);
                attendanceHistory.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                        Error loading attendance history
                    </div>
                `;
            }
        }

        // Load class data
        async function loadClassData(classId) {
            try {
                const doc = await db.collection('classes').doc(classId).get();
                
                if (doc.exists) {
                    classData = doc.data();
                    
                    // Update class location
                    if (classData.location) {
                        classLocation = {
                            lat: classData.location.latitude,
                            lng: classData.location.longitude
                        };
                    }
                    
                    // Update session times if different from default
                    if (classData.morningSession) {
                        morningSession = classData.morningSession;
                    }
                    
                    if (classData.afternoonSession) {
                        afternoonSession = classData.afternoonSession;
                    }
                }
            } catch (error) {
                console.error('Error loading class data:', error);
            }
        }

        // Messaging system
        async function loadMessages() {
            if (!currentUser || !userData) return;
            
            try {
                let query;
                
                if (userData.role === 'student') {
                    // Students see messages between them and their teacher
                    query = db.collection('messages')
                        .where('classId', '==', userData.classId)
                        .where('recipientId', 'in', [currentUser.uid, userData.teacherId])
                        .orderBy('timestamp', 'desc')
                        .limit(50);
                } else if (userData.role === 'teacher') {
                    // Teachers see messages in their classes
                    query = db.collection('messages')
                        .where('classId', '==', userData.classId)
                        .orderBy('timestamp', 'desc')
                        .limit(50);
                } else {
                    // Admins see all messages
                    query = db.collection('messages')
                        .orderBy('timestamp', 'desc')
                        .limit(50);
                }
                
                const snapshot = await query.get();
                
                // Also get offline messages
                const offlineMessages = await getOfflineData('messages');
                const allMessages = [
                    ...snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    ...offlineMessages.filter(item => !item.synced)
                ];
                
                // Sort by timestamp (newest first)
                allMessages.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                // Display in UI
                messagesList.innerHTML = '';
                
                if (allMessages.length === 0) {
                    messagesList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No messages yet
                        </div>
                    `;
                    return;
                }
                
                allMessages.forEach(message => {
                    const isCurrentUser = message.senderId === currentUser.uid;
                    const timestamp = message.timestamp.toDate();
                    const formattedTime = timestamp.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.style.marginBottom = '15px';
                    messageDiv.style.padding = '12px';
                    messageDiv.style.borderRadius = '10px';
                    messageDiv.style.backgroundColor = isCurrentUser ? 'var(--systemBlue)' : 'var(--systemGray6)';
                    messageDiv.style.color = isCurrentUser ? 'white' : 'var(--labelPrimary)';
                    messageDiv.style.maxWidth = '80%';
                    messageDiv.style.marginLeft = isCurrentUser ? 'auto' : '0';
                    
                    messageDiv.innerHTML = `
                        <div style="font-weight: 500; margin-bottom: 5px;">
                            ${message.senderName} ‚Ä¢ ${formattedTime}
                        </div>
                        <div>${message.text}</div>
                    `;
                    
                    messagesList.appendChild(messageDiv);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                        Error loading messages
                    </div>
                `;
            }
        }

        async function sendMessage() {
            if (!currentUser || !userData || !messageInput.value.trim()) return;
            
            try {
                sendMessageBtn.disabled = true;
                sendMessageBtn.innerHTML = '<div class="loading"></div>';
                
                const messageData = {
                    text: messageInput.value.trim(),
                    senderId: currentUser.uid,
                    senderName: userData.name || currentUser.email,
                    timestamp: new Date(),
                    classId: userData.classId || null
                };
                
                if (userData.role === 'student') {
                    // Students send to their teacher
                    messageData.recipientId = userData.teacherId;
                } else if (userData.role === 'teacher') {
                    // Teachers can specify recipient (or send to class)
                    messageData.recipientId = null; // To whole class
                }
                
                // Add to Firestore
                await db.collection('messages').add(messageData);
                
                // Add to offline storage
                await addToOfflineStorage('messages', {
                    ...messageData,
                    id: `offline-${Date.now()}`,
                    synced: false
                });
                
                // Clear input and reload messages
                messageInput.value = '';
                loadMessages();
                
                showToast('Message sent', '‚úÖ');
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message', '‚ùå');
            } finally {
                sendMessageBtn.disabled = false;
                sendMessageBtn.textContent = 'Send';
            }
        }

        // Permission management
        function requestInitialPermissions() {
            // Request location permission if not already granted
            if (!permissions.location) {
                setTimeout(() => {
                    requestPermission('location');
                }, 1000);
            }
        }

        function requestPermission(permission, callback) {
            requestedPermission = permission;
            
            // Store callback if provided
            if (callback) {
                permissionCallbacks[permission] = callback;
            }
            
            // Show appropriate permission explanation
            switch (permission) {
                case 'location':
                    permissionModalTitle.textContent = 'Location Access';
                    permissionModalIcon.textContent = 'üìç';
                    permissionName.textContent = 'your location';
                    permissionReason.textContent = 'We need your location to verify you are physically present in class.';
                    permissionUse1.textContent = 'Verify your attendance location';
                    permissionUse2.textContent = 'Ensure you are within the allowed distance';
                    permissionUse3.textContent = 'Prevent fraudulent check-ins';
                    break;
                    
                case 'notifications':
                    permissionModalTitle.textContent = 'Notifications';
                    permissionModalIcon.textContent = 'üîî';
                    permissionName.textContent = 'notifications';
                    permissionReason.textContent = 'We can notify you about class reminders and important updates.';
                    permissionUse1.textContent = 'Send class reminders';
                    permissionUse2.textContent = 'Notify about schedule changes';
                    permissionUse3.textContent = 'Alert you about important announcements';
                    break;
                    
                case 'camera':
                    permissionModalTitle.textContent = 'Camera Access';
                    permissionModalIcon.textContent = 'üì∑';
                    permissionName.textContent = 'your camera';
                    permissionReason.textContent = 'For future photo verification during check-in (optional).';
                    permissionUse1.textContent = 'Optional photo verification';
                    permissionUse2.textContent = 'Enhanced security for attendance';
                    permissionUse3.textContent = 'Not currently required for check-in';
                    break;
            }
            
            permissionModal.classList.add('active');
        }

        function grantPermission() {
            if (!requestedPermission) return;
            
            switch (requestedPermission) {
                case 'location':
                    // Request geolocation permission
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            () => {
                                permissions.location = true;
                                updatePermissionUI();
                                showToast('Location access granted', '‚úÖ');
                                
                                // Start location tracking
                                startLocationTracking();
                                
                                // Execute callback if exists
                                if (permissionCallbacks.location) {
                                    permissionCallbacks.location();
                                    delete permissionCallbacks.location;
                                }
                            },
                            (error) => {
                                showToast('Location access denied', '‚ö†Ô∏è');
                                console.error('Geolocation error:', error);
                            }
                        );
                    } else {
                        showToast('Geolocation not supported', '‚ö†Ô∏è');
                    }
                    break;
                    
                case 'notifications':
                    // Request notification permission
                    if ('Notification' in window) {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                permissions.notifications = true;
                                updatePermissionUI();
                                showToast('Notifications enabled', '‚úÖ');
                                
                                // Execute callback if exists
                                if (permissionCallbacks.notifications) {
                                    permissionCallbacks.notifications();
                                    delete permissionCallbacks.notifications;
                                }
                            } else {
                                showToast('Notifications blocked', '‚ö†Ô∏è');
                            }
                        });
                    } else {
                        showToast('Notifications not supported', '‚ö†Ô∏è');
                    }
                    break;
                    
                case 'camera':
                    // Request camera permission
                    if ('mediaDevices' in navigator) {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                // Immediately stop the stream as we don't need it yet
                                stream.getTracks().forEach(track => track.stop());
                                
                                permissions.camera = true;
                                updatePermissionUI();
                                showToast('Camera access granted', '‚úÖ');
                                
                                // Execute callback if exists
                                if (permissionCallbacks.camera) {
                                    permissionCallbacks.camera();
                                    delete permissionCallbacks.camera;
                                }
                            })
                            .catch(error => {
                                showToast('Camera access denied', '‚ö†Ô∏è');
                                console.error('Camera error:', error);
                            });
                    } else {
                        showToast('Camera not supported', '‚ö†Ô∏è');
                    }
                    break;
            }
            
            permissionModal.classList.remove('active');
            requestedPermission = null;
        }

        function denyPermission() {
            showToast(`${requestedPermission} permission denied`, '‚ö†Ô∏è');
            permissionModal.classList.remove('active');
            requestedPermission = null;
        }

        function updatePermissionUI() {
            locationToggle.classList.toggle('active', permissions.location);
            notificationsToggle.classList.toggle('active', permissions.notifications);
            cameraToggle.classList.toggle('active', permissions.camera);
        }

        function loadPermissions() {
            if (!dbPromise) return;
            
            dbPromise.then(db => {
                const tx = db.transaction('settings', 'readonly');
                const store = tx.objectStore('settings');
                const request = store.get('permissions');
                
                request.onsuccess = () => {
                    if (request.result) {
                        permissions = request.result.value;
                        updatePermissionUI();
                    }
                };
            });
        }

        function savePermissions() {
            if (!dbPromise) return;
            
            dbPromise.then(db => {
                const tx = db.transaction('settings', 'readwrite');
                const store = tx.objectStore('settings');
                store.put({ key: 'permissions', value: permissions });
            });
        }

        // Location tracking
        function startLocationTracking() {
            if ('geolocation' in navigator && permissions.location) {
                navigator.geolocation.watchPosition(
                    position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Get address from coordinates
                        getAddressFromCoords(currentLocation.lat, currentLocation.lng)
                            .then(address => {
                                locationInput.value = address;
                            })
                            .catch(error => {
                                console.error('Geocoding error:', error);
                                locationInput.value = `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
                            });
                        
                        // Calculate distance from class
                        if (classLocation) {
                            const distance = calculateDistance(
                                currentLocation.lat, currentLocation.lng,
                                classLocation.lat, classLocation.lng
                            );
                            distanceInput.value = `${distance.toFixed(2)} meters`;
                        }
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        locationInput.value = 'Location access denied';
                        distanceInput.value = 'Unknown';
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                locationInput.value = 'Geolocation not supported';
                distanceInput.value = 'Unknown';
            }
        }

        // Offline support
        async function loadOfflineData() {
            if (!dbPromise) return;
            
            try {
                const db = await dbPromise;
                
                // Check for unsynced data and try to sync
                await syncOfflineData();
            } catch (error) {
                console.error('Error loading offline data:', error);
            }
        }

        async function addToOfflineStorage(storeName, data) {
            if (!dbPromise) return;
            
            try {
                const db = await dbPromise;
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                await store.add(data);
            } catch (error) {
                console.error('Error adding to offline storage:', error);
            }
        }

        async function getOfflineData(storeName) {
            if (!dbPromise) return [];
            
            try {
                const db = await dbPromise;
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return await store.getAll();
            } catch (error) {
                console.error('Error getting offline data:', error);
                return [];
            }
        }

        async function syncOfflineData() {
            if (!navigator.onLine || !currentUser || !dbPromise) return;
            
            try {
                const db = await dbPromise;
                
                // Sync attendance
                const attendanceTx = db.transaction('attendance', 'readwrite');
                const attendanceStore = attendanceTx.objectStore('attendance');
                const unsyncedAttendance = await attendanceStore.getAll();
                
                for (const item of unsyncedAttendance) {
                    if (!item.synced) {
                        try {
                            // Remove the offline ID and synced flag
                            const { id, synced, ...data } = item;
                            await db.collection('attendance').add(data);
                            
                            // Mark as synced in IndexedDB
                            await attendanceStore.put({ ...item, synced: true });
                        } catch (error) {
                            console.error('Error syncing attendance:', error);
                        }
                    }
                }
                
                // Sync messages
                const messagesTx = db.transaction('messages', 'readwrite');
                const messagesStore = messagesTx.objectStore('messages');
                const unsyncedMessages = await messagesStore.getAll();
                
                for (const item of unsyncedMessages) {
                    if (!item.synced) {
                        try {
                            // Remove the offline ID and synced flag
                            const { id, synced, ...data } = item;
                            await db.collection('messages').add(data);
                            
                            // Mark as synced in IndexedDB
                            await messagesStore.put({ ...item, synced: true });
                        } catch (error) {
                            console.error('Error syncing message:', error);
                        }
                    }
                }
                
                // Reload data to reflect changes
                if (userData?.role === 'admin' || userData?.role === 'teacher') {
                    loadAttendanceHistory();
                }
                loadMessages();
            } catch (error) {
                console.error('Error syncing offline data:', error);
            }
        }

        function handleOnline() {
            syncOfflineData();
            showToast('Back online - syncing data', 'üåê');
        }

        function handleOffline() {
            showToast('Offline - working locally', 'üì¥');
        }

        // Data encryption
        function encryptData(data) {
            try {
                return 'ENC:' + CryptoJS.AES.encrypt(data, ENCRYPTION_KEY).toString();
            } catch (error) {
                console.error('Encryption error:', error);
                return data;
            }
        }

        function decryptData(encryptedData) {
            try {
                if (encryptedData.startsWith('ENC:')) {
                    const bytes = CryptoJS.AES.decrypt(encryptedData.substring(4), ENCRYPTION_KEY);
                    return bytes.toString(CryptoJS.enc.Utf8) || encryptedData;
                }
                return encryptedData;
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedData;
            }
        }

        // UI Helpers
        function showToast(message, icon = '‚ÑπÔ∏è') {
            toastMessage.textContent = message;
            toastIcon.textContent = icon;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showConfirmDialog(title, message, details, confirmAction, cancelAction) {
            // In a real app, you would implement a proper modal dialog
            if (confirm(`${title}\n\n${message}\n\n${details}\n\nPress OK to confirm.`)) {
                confirmAction();
            } else {
                cancelAction();
            }
        }

        function createRipple(event) {
            const button = event.target;
            const rect = button.getBoundingClientRect();
            const diameter = Math.max(rect.width, rect.height);
            const radius = diameter / 2;
            
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.width = ripple.style.height = `${diameter}px`;
            ripple.style.left = `${event.clientX - rect.left - radius}px`;
            ripple.style.top = `${event.clientY - rect.top - radius}px`;
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Spring animation for buttons
        function springAnimation(element) {
            element.classList.add('spring-animation');
            element.addEventListener('animationend', () => {
                element.classList.remove('spring-animation');
            }, { once: true });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);

        // Check for class invite link on load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const classId = urlParams.get('class');
            
            if (classId) {
                // Store class ID for when user signs up
                localStorage.setItem('secureAttendClassId', classId);
                
                // If already signed in, join the class
                if (currentUser) {
                    joinClass(classId);
                }
            }
        });

        async function joinClass(classId) {
            try {
                // Verify class exists
                const classDoc = await db.collection('classes').doc(classId).get();
                
                if (!classDoc.exists) {
                    showToast('Invalid class invite', '‚ö†Ô∏è');
                    return;
                }
                
                // Update user's class
                await db.collection('users').doc(currentUser.uid).update({
                    classId: classId,
                    teacherId: classDoc.data().teacherId
                });
                
                // Update local user data
                userData.classId = classId;
                userData.teacherId = classDoc.data().teacherId;
                
                showToast('Joined class successfully!', '‚úÖ');
                
                // Remove class ID from storage
                localStorage.removeItem('secureAttendClassId');
                
                // Remove from URL without reload
                const url = new URL(window.location);
                url.searchParams.delete('class');
                window.history.replaceState({}, '', url);
                
                // Reload data
                loadClassData(classId);
                loadAttendanceHistory();
                loadMessages();
            } catch (error) {
                console.error('Error joining class:', error);
                showToast('Failed to join class', '‚ùå');
            }
        }
    </script>
</body>
</html>