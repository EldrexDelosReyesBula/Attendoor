<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fingerprintjs2@2.1.4/dist/fingerprint2.min.js"></script>
    <style>
        :root {
            --systemBlue: #0A84FF;
            --systemGreen: #30D158;
            --systemRed: #FF453A;
            --systemGray: #8E8E93;
            --systemGray2: #636366;
            --systemGray6: #F2F2F7;
            --labelPrimary: #000000;
            --labelSecondary: #3C3C4399;
            --backgroundPrimary: #FFFFFF;
            --backgroundSecondary: #F2F2F7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--backgroundSecondary);
            color: var(--labelPrimary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--backgroundPrimary);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        header {
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--systemBlue);
        }

        .nav-button {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: var(--systemBlue);
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .nav-button:active {
            background-color: rgba(10, 132, 255, 0.1);
            transform: scale(0.96);
        }

        .card {
            background-color: var(--backgroundPrimary);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--labelSecondary);
            margin-top: 4px;
        }

        .button {
            background-color: var(--systemBlue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .button:disabled {
            background-color: var(--systemGray);
            opacity: 0.6;
        }

        .button:active:not(:disabled) {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .button-success {
            background-color: var(--systemGreen);
        }

        .button-danger {
            background-color: var(--systemRed);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--systemGreen);
        }

        .status-inactive {
            background-color: var(--systemGray);
        }

        .attendance-time {
            font-size: 16px;
            font-weight: 500;
            margin: 20px 0;
            text-align: center;
        }

        .progress-container {
            height: 5px;
            background-color: var(--systemGray6);
            border-radius: 2.5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--systemBlue);
            border-radius: 2.5px;
            transition: width 0.3s ease-out;
        }

        .tab-bar {
            display: flex;
            background-color: var(--backgroundPrimary);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--labelSecondary);
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .tab.active {
            background-color: var(--systemBlue);
            color: white;
        }

        .attendance-history {
            margin-top: 20px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--systemGray6);
        }

        .history-date {
            font-weight: 500;
        }

        .history-status {
            font-weight: 500;
        }

        .status-present {
            color: var(--systemGreen);
        }

        .status-absent {
            color: var(--systemRed);
        }

        .status-late {
            color: #FF9F0A;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--backgroundPrimary);
            width: 90%;
            max-width: 400px;
            border-radius: 14px;
            padding: 20px;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--labelSecondary);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--labelSecondary);
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--systemGray6);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            border-color: var(--systemBlue);
            outline: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.4, 1);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: var(--systemBlue);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .user-name {
            font-weight: 500;
            font-size: 16px;
        }

        .user-role {
            font-size: 14px;
            color: var(--labelSecondary);
            margin-top: 2px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .button {
                padding: 10px 15px;
            }
        }

        /* Physics-based animations */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Spring animation for buttons */
        @keyframes spring {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .spring-animation {
            animation: spring 0.4s cubic-bezier(0.2, 0.8, 0.4, 1.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">SecureAttend</div>
            <button class="nav-button" id="authButton">Sign In</button>
        </header>

        <div id="authSection">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Welcome to SecureAttend</div>
                        <div class="card-subtitle">Secure, privacy-focused attendance system</div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Email</label>
                    <input type="email" class="input-field" id="emailInput" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" class="input-field" id="passwordInput" placeholder="••••••••">
                </div>
                <button class="button" id="loginButton">Sign In</button>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="nav-button" id="toggleSignUp">Create Account</button>
                </div>
            </div>
        </div>

        <div id="appSection" style="display: none;">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div class="user-name" id="userName">User Name</div>
                    <div class="user-role" id="userRole">Student</div>
                </div>
            </div>

            <div class="tab-bar">
                <div class="tab active" data-tab="checkin">Check In</div>
                <div class="tab" data-tab="history">History</div>
                <div class="tab" data-tab="messages">Messages</div>
            </div>

            <div id="checkinTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Morning Session</div>
                            <div class="card-subtitle">Available until 10:00 AM</div>
                        </div>
                        <div><span class="status-indicator status-inactive"></span></div>
                    </div>
                    <div class="attendance-time" id="morningTime">--:--</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="morningProgress" style="width: 0%"></div>
                    </div>
                    <button class="button" id="morningCheckinBtn" disabled>Check In</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Afternoon Session</div>
                            <div class="card-subtitle">Available until 4:00 PM</div>
                        </div>
                        <div><span class="status-indicator status-inactive"></span></div>
                    </div>
                    <div class="attendance-time" id="afternoonTime">--:--</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="afternoonProgress" style="width: 0%"></div>
                    </div>
                    <button class="button" id="afternoonCheckinBtn" disabled>Check In</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Location Verification</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Current Location</label>
                        <input type="text" class="input-field" id="locationInput" placeholder="Acquiring location..." readonly>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Distance from Class</label>
                        <input type="text" class="input-field" id="distanceInput" placeholder="Calculating..." readonly>
                    </div>
                </div>
            </div>

            <div id="historyTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Attendance History</div>
                    </div>
                    <div class="attendance-history" id="attendanceHistory">
                        <!-- History items will be added here dynamically -->
                        <div class="history-item">
                            <div class="history-date">Loading...</div>
                            <div class="history-status">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messagesTab" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Messages</div>
                    </div>
                    <div id="messagesList">
                        <!-- Messages will be added here dynamically -->
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No messages yet
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 15px;">
                        <label class="input-label">New Message</label>
                        <textarea class="input-field" id="messageInput" placeholder="Type your message..." rows="3"></textarea>
                    </div>
                    <button class="button" id="sendMessageBtn">Send</button>
                </div>
            </div>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Admin Dashboard</div>
                </div>
                <button class="button" id="manageClassesBtn">Manage Classes</button>
                <button class="button" style="margin-top: 10px;" id="exportDataBtn">Export Attendance Data</button>
                <button class="button button-danger" style="margin-top: 10px;" id="logoutBtn">Log Out</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="modal-close" id="closeAuthModal">&times;</button>
            <div class="modal-title" id="authModalTitle">Sign In</div>
            <div class="input-group">
                <label class="input-label">Email</label>
                <input type="email" class="input-field" id="modalEmailInput" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <input type="password" class="input-field" id="modalPasswordInput" placeholder="••••••••">
            </div>
            <div class="input-group" id="confirmPasswordGroup" style="display: none;">
                <label class="input-label">Confirm Password</label>
                <input type="password" class="input-field" id="modalConfirmPasswordInput" placeholder="••••••••">
            </div>
            <button class="button" id="modalAuthButton">Sign In</button>
            <div style="text-align: center; margin-top: 15px;">
                <button class="nav-button" id="modalToggleAuth">Create Account Instead</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration

const firebaseConfig = {
  apiKey: "AIzaSyCVP8zaUj2iDrooLbRQNypHqB8QNTLhGDE",
  authDomain: "attendance-fe1c8.firebaseapp.com",
  projectId: "attendance-fe1c8",
  storageBucket: "attendance-fe1c8.firebasestorage.app",
  messagingSenderId: "903463376704",
  appId: "1:903463376704:web:d004c563d56aa286df8ca5",
  measurementId: "G-YY5GQZPSRK"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const adminSection = document.getElementById('adminSection');
        const authButton = document.getElementById('authButton');
        const loginButton = document.getElementById('loginButton');
        const toggleSignUp = document.getElementById('toggleSignUp');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const morningCheckinBtn = document.getElementById('morningCheckinBtn');
        const afternoonCheckinBtn = document.getElementById('afternoonCheckinBtn');
        const morningTime = document.getElementById('morningTime');
        const afternoonTime = document.getElementById('afternoonTime');
        const morningProgress = document.getElementById('morningProgress');
        const afternoonProgress = document.getElementById('afternoonProgress');
        const locationInput = document.getElementById('locationInput');
        const distanceInput = document.getElementById('distanceInput');
        const attendanceHistory = document.getElementById('attendanceHistory');
        const messagesList = document.getElementById('messagesList');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const authModal = document.getElementById('authModal');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const modalAuthButton = document.getElementById('modalAuthButton');
        const modalToggleAuth = document.getElementById('modalToggleAuth');
        const modalEmailInput = document.getElementById('modalEmailInput');
        const modalPasswordInput = document.getElementById('modalPasswordInput');
        const modalConfirmPasswordInput = document.getElementById('modalConfirmPasswordInput');
        const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
        const authModalTitle = document.getElementById('authModalTitle');
        const toast = document.getElementById('toast');
        const manageClassesBtn = document.getElementById('manageClassesBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // Global Variables
        let isSignUp = false;
        let currentUser = null;
        let userData = null;
        let deviceFingerprint = null;
        let currentLocation = null;
        let classLocation = { lat: 37.7749, lng: -122.4194 }; // Default to San Francisco
        let morningSession = { start: 7, end: 10 }; // 7AM to 10AM
        let afternoonSession = { start: 13, end: 16 }; // 1PM to 4PM
        let offlineData = {
            attendance: [],
            messages: []
        };

        // Initialize IndexedDB for offline support
        let dbPromise;
        if ('indexedDB' in window) {
            dbPromise = new Promise((resolve, reject) => {
                const request = indexedDB.open('SecureAttendDB', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('attendance')) {
                        db.createObjectStore('attendance', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('messages')) {
                        db.createObjectStore('messages', { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            getDeviceFingerprint();
            loadOfflineData();
            
            // Check network status
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Initialize tabs
            switchTab('checkin');
        }

        // Set up event listeners
        function setupEventListeners() {
            // Auth buttons
            authButton.addEventListener('click', () => authModal.classList.add('active'));
            loginButton.addEventListener('click', handleAuth);
            toggleSignUp.addEventListener('click', () => {
                isSignUp = !isSignUp;
                toggleSignUp.textContent = isSignUp ? 'Sign In Instead' : 'Create Account';
            });
            
            // Modal auth
            closeAuthModal.addEventListener('click', () => authModal.classList.remove('active'));
            modalAuthButton.addEventListener('click', handleModalAuth);
            modalToggleAuth.addEventListener('click', toggleAuthMode);
            
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Check-in buttons
            morningCheckinBtn.addEventListener('click', () => checkIn('morning'));
            afternoonCheckinBtn.addEventListener('click', () => checkIn('afternoon'));
            
            // Messages
            sendMessageBtn.addEventListener('click', sendMessage);
            
            // Admin buttons
            manageClassesBtn.addEventListener('click', manageClasses);
            exportDataBtn.addEventListener('click', exportData);
            logoutBtn.addEventListener('click', signOut);
            
            // Ripple effect for buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('button') || e.target.classList.contains('nav-button')) {
                    createRipple(e);
                }
            });
        }

        // Authentication handlers
        function handleAuth() {
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showToast('Please enter email and password');
                return;
            }
            
            if (isSignUp) {
                signUp(email, password);
            } else {
                signIn(email, password);
            }
        }

        function handleModalAuth() {
            const email = modalEmailInput.value;
            const password = modalPasswordInput.value;
            const confirmPassword = modalConfirmPasswordInput.value;
            
            if (!email || !password) {
                showToast('Please enter email and password');
                return;
            }
            
            if (isSignUp) {
                if (password !== confirmPassword) {
                    showToast('Passwords do not match');
                    return;
                }
                signUp(email, password);
            } else {
                signIn(email, password);
            }
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            confirmPasswordGroup.style.display = isSignUp ? 'block' : 'none';
            authModalTitle.textContent = isSignUp ? 'Create Account' : 'Sign In';
            modalAuthButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            modalToggleAuth.textContent = isSignUp ? 'Sign In Instead' : 'Create Account';
        }

        async function signIn(email, password) {
            try {
                modalAuthButton.disabled = true;
                modalAuthButton.innerHTML = '<div class="loading"></div>';
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                showToast('Signed in successfully');
                authModal.classList.remove('active');
                loadUserData();
            } catch (error) {
                console.error('Sign in error:', error);
                showToast(error.message);
            } finally {
                modalAuthButton.disabled = false;
                modalAuthButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            }
        }

        async function signUp(email, password) {
            try {
                modalAuthButton.disabled = true;
                modalAuthButton.innerHTML = '<div class="loading"></div>';
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    role: 'student',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Account created successfully');
                authModal.classList.remove('active');
                loadUserData();
            } catch (error) {
                console.error('Sign up error:', error);
                showToast(error.message);
            } finally {
                modalAuthButton.disabled = false;
                modalAuthButton.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            }
        }

        function signOut() {
            auth.signOut().then(() => {
                showToast('Signed out successfully');
                currentUser = null;
                userData = null;
                checkAuthState();
            }).catch(error => {
                console.error('Sign out error:', error);
                showToast(error.message);
            });
        }

        // Check auth state
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authButton.textContent = 'Sign Out';
                    authButton.removeEventListener('click', () => authModal.classList.add('active'));
                    authButton.addEventListener('click', signOut);
                    loadUserData();
                } else {
                    currentUser = null;
                    userData = null;
                    authSection.style.display = 'block';
                    appSection.style.display = 'none';
                    adminSection.style.display = 'none';
                    authButton.textContent = 'Sign In';
                    authButton.removeEventListener('click', signOut);
                    authButton.addEventListener('click', () => authModal.classList.add('active'));
                }
            });
        }

        // Load user data from Firestore
        async function loadUserData() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    userData = doc.data();
                    updateUI();
                    
                    if (userData.role === 'admin' || userData.role === 'teacher') {
                        appSection.style.display = 'none';
                        adminSection.style.display = 'block';
                    } else {
                        appSection.style.display = 'block';
                        adminSection.style.display = 'none';
                    }
                    
                    // Load class data if student is in a class
                    if (userData.classId) {
                        loadClassData(userData.classId);
                    }
                    
                    // Load attendance history
                    loadAttendanceHistory();
                    
                    // Load messages
                    loadMessages();
                    
                    // Start location tracking
                    startLocationTracking();
                    
                    // Update time displays
                    updateTimeDisplays();
                    setInterval(updateTimeDisplays, 1000);
                } else {
                    console.error('No user data found');
                    showToast('User data not found');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading user data');
            }
        }

        // Update UI with user data
        function updateUI() {
            if (!currentUser || !userData) return;
            
            userName.textContent = userData.name || currentUser.email.split('@')[0];
            userRole.textContent = userData.role === 'admin' ? 'Administrator' : 
                                  userData.role === 'teacher' ? 'Teacher' : 'Student';
            
            // Set avatar initials
            const name = userData.name || currentUser.email;
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            userAvatar.textContent = initials;
        }

        // Tab switching
        function switchTab(tabName) {
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabName}Tab`) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
        }

        // Device fingerprinting
        function getDeviceFingerprint() {
            if (typeof Fingerprint2 !== 'undefined') {
                Fingerprint2.get(components => {
                    const values = components.map(component => component.value);
                    deviceFingerprint = Fingerprint2.x64hash128(values.join(''), 31);
                    console.log('Device fingerprint:', deviceFingerprint);
                });
            } else {
                console.warn('FingerprintJS not loaded');
                // Fallback to simpler fingerprint
                deviceFingerprint = 'fp-' + Math.random().toString(36).substring(2, 15);
            }
        }

        // Location tracking
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Get address from coordinates
                        getAddressFromCoords(currentLocation.lat, currentLocation.lng)
                            .then(address => {
                                locationInput.value = address;
                            })
                            .catch(error => {
                                console.error('Geocoding error:', error);
                                locationInput.value = `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
                            });
                        
                        // Calculate distance from class
                        if (classLocation) {
                            const distance = calculateDistance(
                                currentLocation.lat, currentLocation.lng,
                                classLocation.lat, classLocation.lng
                            );
                            distanceInput.value = `${distance.toFixed(2)} meters`;
                        }
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        locationInput.value = 'Location access denied';
                        distanceInput.value = 'Unknown';
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                locationInput.value = 'Geolocation not supported';
                distanceInput.value = 'Unknown';
            }
        }

        // Get address from coordinates
        async function getAddressFromCoords(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    return [
                        address.road || '',
                        address.house_number || '',
                        address.postcode || '',
                        address.city || address.town || address.village || '',
                        address.country || ''
                    ].filter(part => part).join(', ');
                }
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        // Calculate distance between two points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }

        // Time display and check-in availability
        function updateTimeDisplays() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Format current time
            const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Morning session
            if (currentHour >= morningSession.start && currentHour < morningSession.end) {
                // Within morning session
                const totalMinutes = (morningSession.end - morningSession.start) * 60;
                const elapsedMinutes = (currentHour - morningSession.start) * 60 + currentMinute;
                const progress = (elapsedMinutes / totalMinutes) * 100;
                
                morningTime.textContent = formattedTime;
                morningProgress.style.width = `${progress}%`;
                morningCheckinBtn.disabled = false;
                morningCheckinBtn.classList.add('button-success');
                document.querySelector('#checkinTab .card:nth-child(1) .status-indicator').className = 'status-indicator status-active';
            } else {
                // Outside morning session
                morningTime.textContent = formattedTime;
                morningProgress.style.width = '0%';
                morningCheckinBtn.disabled = true;
                morningCheckinBtn.classList.remove('button-success');
                document.querySelector('#checkinTab .card:nth-child(1) .status-indicator').className = 'status-indicator status-inactive';
            }
            
            // Afternoon session
            if (currentHour >= afternoonSession.start && currentHour < afternoonSession.end) {
                // Within afternoon session
                const totalMinutes = (afternoonSession.end - afternoonSession.start) * 60;
                const elapsedMinutes = (currentHour - afternoonSession.start) * 60 + currentMinute;
                const progress = (elapsedMinutes / totalMinutes) * 100;
                
                afternoonTime.textContent = formattedTime;
                afternoonProgress.style.width = `${progress}%`;
                afternoonCheckinBtn.disabled = false;
                afternoonCheckinBtn.classList.add('button-success');
                document.querySelector('#checkinTab .card:nth-child(2) .status-indicator').className = 'status-indicator status-active';
            } else {
                // Outside afternoon session
                afternoonTime.textContent = formattedTime;
                afternoonProgress.style.width = '0%';
                afternoonCheckinBtn.disabled = true;
                afternoonCheckinBtn.classList.remove('button-success');
                document.querySelector('#checkinTab .card:nth-child(2) .status-indicator').className = 'status-indicator status-inactive';
            }
        }

        // Check-in function
        async function checkIn(sessionType) {
            if (!currentUser || !userData || !deviceFingerprint) {
                showToast('Authentication required');
                return;
            }
            
            if (!currentLocation) {
                showToast('Location access required for check-in');
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const sessionTime = sessionType === 'morning' ? morningSession : afternoonSession;
            
            // Verify we're within the session time
            const currentHour = now.getHours();
            if (currentHour < sessionTime.start || currentHour >= sessionTime.end) {
                showToast(`Check-in not available outside ${sessionType} session`);
                return;
            }
            
            // Verify location (within 200m of class)
            const distance = calculateDistance(
                currentLocation.lat, currentLocation.lng,
                classLocation.lat, classLocation.lng
            );
            
            if (distance > 200) {
                showToast('You must be within 200m of class to check in');
                return;
            }
            
            try {
                // Disable button during check-in
                const button = sessionType === 'morning' ? morningCheckinBtn : afternoonCheckinBtn;
                button.disabled = true;
                button.innerHTML = '<div class="loading"></div>';
                
                // Create attendance record
                const attendanceData = {
                    userId: currentUser.uid,
                    userName: userData.name || currentUser.email,
                    classId: userData.classId || null,
                    session: sessionType,
                    date: today,
                    timestamp: now,
                    location: new firebase.firestore.GeoPoint(currentLocation.lat, currentLocation.lng),
                    deviceFingerprint: deviceFingerprint,
                    distance: Math.round(distance),
                    status: 'present'
                };
                
                // Check if already checked in today for this session
                const existingCheckIn = await db.collection('attendance')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', today)
                    .where('session', '==', sessionType)
                    .limit(1)
                    .get();
                
                if (!existingCheckIn.empty) {
                    showToast(`Already checked in for ${sessionType} session`);
                    button.disabled = false;
                    button.textContent = 'Check In';
                    return;
                }
                
                // Add to Firestore
                await db.collection('attendance').add(attendanceData);
                
                // Add to offline storage
                await addToOfflineStorage('attendance', {
                    ...attendanceData,
                    id: `offline-${Date.now()}`,
                    synced: false
                });
                
                showToast(`${sessionType.charAt(0).toUpperCase() + sessionType.slice(1)} check-in successful`);
                
                // Update UI
                button.disabled = true;
                button.textContent = 'Checked In';
                button.classList.remove('button-success');
                
                // Reload history
                loadAttendanceHistory();
            } catch (error) {
                console.error('Check-in error:', error);
                showToast('Check-in failed: ' + error.message);
                
                // Re-enable button
                const button = sessionType === 'morning' ? morningCheckinBtn : afternoonCheckinBtn;
                button.disabled = false;
                button.textContent = 'Check In';
            }
        }

        // Load attendance history
        async function loadAttendanceHistory() {
            if (!currentUser) return;
            
            try {
                const query = db.collection('attendance')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('date', 'desc')
                    .limit(30);
                
                const snapshot = await query.get();
                
                // Also get offline attendance
                const offlineAttendance = await getOfflineData('attendance');
                const allAttendance = [
                    ...snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    ...offlineAttendance.filter(item => !item.synced)
                ];
                
                // Sort by date (newest first)
                allAttendance.sort((a, b) => b.date.toDate() - a.date.toDate());
                
                // Display in UI
                attendanceHistory.innerHTML = '';
                
                if (allAttendance.length === 0) {
                    attendanceHistory.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No attendance records yet
                        </div>
                    `;
                    return;
                }
                
                allAttendance.forEach(record => {
                    const date = record.date.toDate();
                    const formattedDate = date.toLocaleDateString([], { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    const formattedTime = record.timestamp.toDate().toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const statusClass = record.status === 'present' ? 'status-present' : 
                                      record.status === 'absent' ? 'status-absent' : 'status-late';
                    
                    const statusText = record.status === 'present' ? 'Present' : 
                                      record.status === 'absent' ? 'Absent' : 'Late';
                    
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-date">
                            ${formattedDate} • ${record.session.charAt(0).toUpperCase() + record.session.slice(1)}
                        </div>
                        <div class="history-status ${statusClass}">
                            ${statusText} • ${formattedTime}
                        </div>
                    `;
                    
                    attendanceHistory.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading attendance history:', error);
                attendanceHistory.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                        Error loading attendance history
                    </div>
                `;
            }
        }

        // Load class data
        async function loadClassData(classId) {
            try {
                const doc = await db.collection('classes').doc(classId).get();
                
                if (doc.exists) {
                    const classData = doc.data();
                    
                    // Update class location
                    if (classData.location) {
                        classLocation = {
                            lat: classData.location.latitude,
                            lng: classData.location.longitude
                        };
                    }
                    
                    // Update session times if different from default
                    if (classData.morningSession) {
                        morningSession = classData.morningSession;
                    }
                    
                    if (classData.afternoonSession) {
                        afternoonSession = classData.afternoonSession;
                    }
                }
            } catch (error) {
                console.error('Error loading class data:', error);
            }
        }

        // Messaging system
        async function loadMessages() {
            if (!currentUser || !userData) return;
            
            try {
                let query;
                
                if (userData.role === 'student') {
                    // Students see messages between them and their teacher
                    query = db.collection('messages')
                        .where('classId', '==', userData.classId)
                        .where('recipientId', 'in', [currentUser.uid, userData.teacherId])
                        .orderBy('timestamp', 'desc')
                        .limit(50);
                } else if (userData.role === 'teacher') {
                    // Teachers see messages in their classes
                    query = db.collection('messages')
                        .where('classId', '==', userData.classId)
                        .orderBy('timestamp', 'desc')
                        .limit(50);
                } else {
                    // Admins see all messages
                    query = db.collection('messages')
                        .orderBy('timestamp', 'desc')
                        .limit(50);
                }
                
                const snapshot = await query.get();
                
                // Also get offline messages
                const offlineMessages = await getOfflineData('messages');
                const allMessages = [
                    ...snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    ...offlineMessages.filter(item => !item.synced)
                ];
                
                // Sort by timestamp (newest first)
                allMessages.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                // Display in UI
                messagesList.innerHTML = '';
                
                if (allMessages.length === 0) {
                    messagesList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                            No messages yet
                        </div>
                    `;
                    return;
                }
                
                allMessages.forEach(message => {
                    const isCurrentUser = message.senderId === currentUser.uid;
                    const timestamp = message.timestamp.toDate();
                    const formattedTime = timestamp.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.style.marginBottom = '15px';
                    messageDiv.style.padding = '12px';
                    messageDiv.style.borderRadius = '10px';
                    messageDiv.style.backgroundColor = isCurrentUser ? 'var(--systemBlue)' : 'var(--systemGray6)';
                    messageDiv.style.color = isCurrentUser ? 'white' : 'var(--labelPrimary)';
                    messageDiv.style.maxWidth = '80%';
                    messageDiv.style.marginLeft = isCurrentUser ? 'auto' : '0';
                    
                    messageDiv.innerHTML = `
                        <div style="font-weight: 500; margin-bottom: 5px;">
                            ${message.senderName} • ${formattedTime}
                        </div>
                        <div>${message.text}</div>
                    `;
                    
                    messagesList.appendChild(messageDiv);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--labelSecondary);">
                        Error loading messages
                    </div>
                `;
            }
        }

        async function sendMessage() {
            if (!currentUser || !userData || !messageInput.value.trim()) return;
            
            try {
                sendMessageBtn.disabled = true;
                sendMessageBtn.innerHTML = '<div class="loading"></div>';
                
                const messageData = {
                    text: messageInput.value.trim(),
                    senderId: currentUser.uid,
                    senderName: userData.name || currentUser.email,
                    timestamp: new Date(),
                    classId: userData.classId || null
                };
                
                if (userData.role === 'student') {
                    // Students send to their teacher
                    messageData.recipientId = userData.teacherId;
                } else if (userData.role === 'teacher') {
                    // Teachers can specify recipient (or send to class)
                    // In a real app, you'd have UI for this
                    messageData.recipientId = null; // To whole class
                }
                
                // Add to Firestore
                await db.collection('messages').add(messageData);
                
                // Add to offline storage
                await addToOfflineStorage('messages', {
                    ...messageData,
                    id: `offline-${Date.now()}`,
                    synced: false
                });
                
                // Clear input and reload messages
                messageInput.value = '';
                loadMessages();
                
                showToast('Message sent');
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message');
            } finally {
                sendMessageBtn.disabled = false;
                sendMessageBtn.textContent = 'Send';
            }
        }

        // Admin functions
        function manageClasses() {
            showToast('Manage classes feature would open here');
            // In a real app, this would open a class management interface
        }

        async function exportData() {
            try {
                exportDataBtn.disabled = true;
                exportDataBtn.innerHTML = '<div class="loading"></div>';
                
                // Get attendance data
                const snapshot = await db.collection('attendance')
                    .where('classId', '==', userData.classId)
                    .orderBy('date', 'desc')
                    .get();
                
                const data = snapshot.docs.map(doc => doc.data());
                
                // Convert to CSV
                let csv = 'Date,Session,Name,Status,Time,Location,Distance\n';
                
                data.forEach(item => {
                    const date = item.date.toDate().toLocaleDateString();
                    const time = item.timestamp.toDate().toLocaleTimeString();
                    const location = `"${item.location.latitude},${item.location.longitude}"`;
                    
                    csv += `${date},${item.session},${item.userName},${item.status},${time},${location},${item.distance}\n`;
                });
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Data exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Failed to export data');
            } finally {
                exportDataBtn.disabled = false;
                exportDataBtn.textContent = 'Export Attendance Data';
            }
        }

        // Offline support
        async function loadOfflineData() {
            if (!dbPromise) return;
            
            try {
                const db = await dbPromise;
                
                // Check for unsynced data and try to sync
                await syncOfflineData();
            } catch (error) {
                console.error('Error loading offline data:', error);
            }
        }

        async function addToOfflineStorage(storeName, data) {
            if (!dbPromise) return;
            
            try {
                const db = await dbPromise;
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                await store.add(data);
            } catch (error) {
                console.error('Error adding to offline storage:', error);
            }
        }

        async function getOfflineData(storeName) {
            if (!dbPromise) return [];
            
            try {
                const db = await dbPromise;
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                return await store.getAll();
            } catch (error) {
                console.error('Error getting offline data:', error);
                return [];
            }
        }

        async function syncOfflineData() {
            if (!navigator.onLine || !currentUser || !dbPromise) return;
            
            try {
                const db = await dbPromise;
                
                // Sync attendance
                const attendanceTx = db.transaction('attendance', 'readwrite');
                const attendanceStore = attendanceTx.objectStore('attendance');
                const unsyncedAttendance = await attendanceStore.getAll();
                
                for (const item of unsyncedAttendance) {
                    if (!item.synced) {
                        try {
                            // Remove the offline ID and synced flag
                            const { id, synced, ...data } = item;
                            await db.collection('attendance').add(data);
                            
                            // Mark as synced in IndexedDB
                            await attendanceStore.put({ ...item, synced: true });
                        } catch (error) {
                            console.error('Error syncing attendance:', error);
                        }
                    }
                }
                
                // Sync messages
                const messagesTx = db.transaction('messages', 'readwrite');
                const messagesStore = messagesTx.objectStore('messages');
                const unsyncedMessages = await messagesStore.getAll();
                
                for (const item of unsyncedMessages) {
                    if (!item.synced) {
                        try {
                            // Remove the offline ID and synced flag
                            const { id, synced, ...data } = item;
                            await db.collection('messages').add(data);
                            
                            // Mark as synced in IndexedDB
                            await messagesStore.put({ ...item, synced: true });
                        } catch (error) {
                            console.error('Error syncing message:', error);
                        }
                    }
                }
                
                // Reload data to reflect changes
                if (userData?.role === 'admin' || userData?.role === 'teacher') {
                    loadAttendanceHistory();
                }
                loadMessages();
            } catch (error) {
                console.error('Error syncing offline data:', error);
            }
        }

        function handleOnline() {
            syncOfflineData();
            showToast('Back online - syncing data');
        }

        function handleOffline() {
            showToast('Offline - working locally');
        }

        // UI Helpers
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function createRipple(event) {
            const button = event.target;
            const rect = button.getBoundingClientRect();
            const diameter = Math.max(rect.width, rect.height);
            const radius = diameter / 2;
            
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.width = ripple.style.height = `${diameter}px`;
            ripple.style.left = `${event.clientX - rect.left - radius}px`;
            ripple.style.top = `${event.clientY - rect.top - radius}px`;
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Spring animation for buttons
        function springAnimation(element) {
            element.classList.add('spring-animation');
            element.addEventListener('animationend', () => {
                element.classList.remove('spring-animation');
            }, { once: true });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
